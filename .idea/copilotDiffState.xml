<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/.env">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.env" />
              <option name="updatedContent" value="MARIADB_USERNAME=raffles-manager&#10;MARIADB_PASSWORD=raffles&#10;MARIADB_SERVER=localhost&#10;MARIADB_PORT=3306&#10;MARIADB_DATABASE=raffles_draw&#10;DOMAIN=localhost&#10;ENVIRONMENT=local&#10;BACKEND_CORS_ORIGINS=http://localhost,http://localhost:5173&#10;JWT_SECRET_KEY=twq...2s!" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/auth/services/auth_service.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/auth/services/auth_service.py" />
              <option name="originalContent" value="from typing import Annotated&#10;&#10;from jwt.exceptions import InvalidTokenError&#10;#from auth.models.token import TokenData&#10;#from auth.utils.auth_utils import verify_password&#10;from core.config_loader import settings&#10;from fastapi.security import OAuth2PasswordBearer&#10;from sqlalchemy.orm import Session&#10;from fastapi import Depends, HTTPException, status&#10;from datetime import datetime, timedelta, timezone&#10;import jwt&#10;from database.connection import get_db&#10;from models import Users&#10;#from user.services.user_service import get_user_by_email&#10;&#10;SECRET_KEY = settings.JWT_SECRET_KEY&#10;ALGORITHM = &quot;HS256&quot;&#10;&#10;oauth2_scheme = OAuth2PasswordBearer(tokenUrl=&quot;/api/auth/token&quot;)&#10;&#10;&#10;&quot;&quot;&quot;def authenticate_user(email: str, password: str, db:Session = Depends(get_db)):&#10;    user = get_user_by_email(db, email)&#10;    if not user:&#10;        return False&#10;    if not verify_password(password, user.password):&#10;        return False&#10;    return user&quot;&quot;&quot;&#10;&#10;&#10;def create_access_token(data: dict, expires_delta: timedelta | None = None):&#10;    to_encode = data.copy()&#10;    if expires_delta:&#10;        expire = datetime.now(timezone.utc) + expires_delta&#10;    else:&#10;        expire = datetime.now(timezone.utc) + timedelta(minutes=15)&#10;    to_encode.update({&quot;exp&quot;: expire})&#10;    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)&#10;    return encoded_jwt&#10;&#10;&#10;&quot;&quot;&quot;async def get_current_user(token: Annotated[str, Depends(oauth2_scheme)], db:Session = Depends(get_db)):&#10;    credentials_exception = HTTPException(&#10;        status_code=status.HTTP_401_UNAUTHORIZED,&#10;        detail=&quot;Could not validate credentials&quot;,&#10;        headers={&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;},&#10;    )&#10;    try:&#10;        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])&#10;        email = payload.get(&quot;sub&quot;)&#10;        if email is None:&#10;            raise credentials_exception&#10;        token_data = TokenData(email=email)&#10;    except InvalidTokenError:&#10;        raise credentials_exception&#10;    user = get_user_by_email(db, email=token_data.email)&#10;    if user is None:&#10;        raise credentials_exception&#10;    return user&quot;&quot;&quot;&#10;&#10;&#10;&quot;&quot;&quot;async def get_current_active_user(current_user: Users = Depends(get_current_user)):&#10;    return current_user&quot;&quot;&quot;" />
              <option name="updatedContent" value="from typing import Annotated&#10;&#10;from jwt.exceptions import InvalidTokenError&#10;#from auth.models.token import TokenData&#10;#from auth.utils.auth_utils import verify_password&#10;from core.config_loader import settings&#10;from fastapi.security import OAuth2PasswordBearer&#10;from sqlalchemy.orm import Session&#10;from fastapi import Depends, HTTPException, status&#10;from datetime import datetime, timedelta, timezone&#10;import jwt&#10;from database.connection import get_db&#10;from models import User  # Changed from Users to User&#10;#from user.services.user_service import get_user_by_email&#10;&#10;SECRET_KEY = settings.JWT_SECRET_KEY&#10;ALGORITHM = &quot;HS256&quot;&#10;&#10;oauth2_scheme = OAuth2PasswordBearer(tokenUrl=&quot;/api/auth/token&quot;)&#10;&#10;&#10;&quot;&quot;&quot;def authenticate_user(email: str, password: str, db:Session = Depends(get_db)):&#10;    user = get_user_by_email(db, email)&#10;    if not user:&#10;        return False&#10;    if not verify_password(password, user.password):&#10;        return False&#10;    return user&quot;&quot;&quot;&#10;&#10;&#10;def create_access_token(data: dict, expires_delta: timedelta | None = None):&#10;    to_encode = data.copy()&#10;    if expires_delta:&#10;        expire = datetime.now(timezone.utc) + expires_delta&#10;    else:&#10;        expire = datetime.now(timezone.utc) + timedelta(minutes=15)&#10;    to_encode.update({&quot;exp&quot;: expire})&#10;    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)&#10;    return encoded_jwt&#10;&#10;&#10;&quot;&quot;&quot;async def get_current_user(token: Annotated[str, Depends(oauth2_scheme)], db:Session = Depends(get_db)):&#10;    credentials_exception = HTTPException(&#10;        status_code=status.HTTP_401_UNAUTHORIZED,&#10;        detail=&quot;Could not validate credentials&quot;,&#10;        headers={&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;},&#10;    )&#10;    try:&#10;        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])&#10;        email = payload.get(&quot;sub&quot;)&#10;        if email is None:&#10;            raise credentials_exception&#10;        token_data = TokenData(email=email)&#10;    except InvalidTokenError:&#10;        raise credentials_exception&#10;    user = get_user_by_email(db, email=token_data.email)&#10;    if user is None:&#10;        raise credentials_exception&#10;    return user&quot;&quot;&quot;&#10;&#10;&#10;&quot;&quot;&quot;async def get_current_active_user(current_user: Users = Depends(get_current_user)):&#10;    return current_user&quot;&quot;&quot;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/core/__init__.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/core/__init__.py" />
              <option name="originalContent" value="from sqlalchemy import create_engine&#10;from core.database import setup_mysql&#10;from core.config_loader import settings&#10;&#10;if True or setup_mysql():&#10;    sys_engine = create_engine(f&quot;mysql+pymysql://{settings.MARIADB_USERNAME}:{settings.MARIADB_PASSWORD}@{settings.MARIADB_SERVER}&quot;)&#10;" />
              <option name="updatedContent" value="from sqlalchemy import create_engine&#10;from core.database import setup_mysql&#10;from core.config_loader import settings&#10;&#10;# Remove immediate database setup that hangs during import&#10;# Only create the engine definition, don't execute setup&#10;def get_sys_engine():&#10;    if setup_mysql():&#10;        return create_engine(f&quot;mysql+pymysql://{settings.MARIADB_USERNAME}:{settings.MARIADB_PASSWORD}@{settings.MARIADB_SERVER}&quot;)&#10;    return None&#10;&#10;# Make sys_engine lazy-loaded&#10;sys_engine = None" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/core/config.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/core/config.py" />
              <option name="originalContent" value="from pydantic_settings import BaseSettings, SettingsConfigDict&#10;from typing import Annotated, Any, Literal&#10;&#10;from pydantic import (&#10;    AnyUrl,&#10;    BeforeValidator,&#10;    computed_field,&#10;    MariaDBDsn,&#10;    Field&#10;)&#10;&#10;from pydantic_core import MultiHostUrl&#10;&#10;&#10;def parse_cors(v: Any) -&gt; list[str] | str:&#10;    if isinstance(v, str) and not v.startswith(&quot;[&quot;):&#10;        return [i.strip() for i in v.split(&quot;,&quot;)]&#10;    elif isinstance(v, list | str):&#10;        return v&#10;    raise ValueError(v)&#10;&#10;&#10;class Settings(BaseSettings):&#10;    model_config = SettingsConfigDict(&#10;        env_file='.env',&#10;        env_file_encoding='utf-8',&#10;        extra=&quot;ignore&quot;,&#10;        env_ignore_empty = True,&#10;    )&#10;    DOMAIN: str = 'localhost'&#10;    ENVIRONMENT: Literal[&quot;local&quot;, &quot;staging&quot;, &quot;production&quot;] = &quot;local&quot;&#10;    JWT_SECRET_KEY: str&#10;&#10;    @computed_field&#10;    @property&#10;    def server_host(self) -&gt; str:&#10;        # Use HTTPS for anything other than local development&#10;        if self.ENVIRONMENT == &quot;local&quot;:&#10;            return f&quot;http://{self.DOMAIN}&quot;&#10;        return f&quot;https://{self.DOMAIN}&quot;&#10;&#10;    BACKEND_CORS_ORIGINS: Annotated[list[AnyUrl] | str, BeforeValidator(parse_cors)] = Field(default=lambda: [])&#10;&#10;    MARIADB_USERNAME: str&#10;    MARIADB_PASSWORD: str&#10;    MARIADB_SERVER: str&#10;    MARIADB_PORT: int&#10;    MARIADB_DATABASE: str&#10;&#10;    @computed_field  # type: ignore[misc]&#10;    @property&#10;    def SQLALCHEMY_DATABASE_URI(self) -&gt; MariaDBDsn | MultiHostUrl:&#10;        return MultiHostUrl.build(&#10;            scheme=&quot;mysql+pymysql&quot;,&#10;            username=self.MARIADB_USERNAME,&#10;            password=self.MARIADB_PASSWORD,&#10;            host=self.MARIADB_SERVER,&#10;            port=self.MARIADB_PORT,&#10;            path=self.MARIADB_DATABASE&#10;        )" />
              <option name="updatedContent" value="from pydantic_settings import BaseSettings, SettingsConfigDict&#10;from typing import Annotated, Any, Literal&#10;&#10;from pydantic import (&#10;    AnyUrl,&#10;    BeforeValidator,&#10;    computed_field,&#10;    Field&#10;)&#10;&#10;&#10;def parse_cors(v: Any) -&gt; list[str] | str:&#10;    if isinstance(v, str) and not v.startswith(&quot;[&quot;):&#10;        return [i.strip() for i in v.split(&quot;,&quot;)]&#10;    elif isinstance(v, list | str):&#10;        return v&#10;    raise ValueError(v)&#10;&#10;&#10;class Settings(BaseSettings):&#10;    model_config = SettingsConfigDict(&#10;        env_file='.env',&#10;        env_file_encoding='utf-8',&#10;        extra=&quot;ignore&quot;,&#10;        env_ignore_empty = True,&#10;    )&#10;    DOMAIN: str = 'localhost'&#10;    ENVIRONMENT: Literal[&quot;local&quot;, &quot;staging&quot;, &quot;production&quot;] = &quot;local&quot;&#10;    JWT_SECRET_KEY: str&#10;&#10;    @computed_field&#10;    @property&#10;    def server_host(self) -&gt; str:&#10;        # Use HTTPS for anything other than local development&#10;        if self.ENVIRONMENT == &quot;local&quot;:&#10;            return f&quot;http://{self.DOMAIN}&quot;&#10;        return f&quot;https://{self.DOMAIN}&quot;&#10;&#10;    BACKEND_CORS_ORIGINS: Annotated[list[AnyUrl] | str, BeforeValidator(parse_cors)] = Field(default=lambda: [])&#10;&#10;    MARIADB_USERNAME: str&#10;    MARIADB_PASSWORD: str&#10;    MARIADB_SERVER: str&#10;    MARIADB_PORT: int&#10;    MARIADB_DATABASE: str&#10;&#10;    @computed_field&#10;    @property&#10;    def SQLALCHEMY_DATABASE_URI(self) -&gt; str:&#10;        # Return simple string instead of complex MariaDBDsn to prevent validation hanging&#10;        return f&quot;mysql+pymysql://{self.MARIADB_USERNAME}:{self.MARIADB_PASSWORD}@{self.MARIADB_SERVER}:{self.MARIADB_PORT}/{self.MARIADB_DATABASE}&quot;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/core/database.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/core/database.py" />
              <option name="originalContent" value="import subprocess&#10;import sys&#10;from core.config_loader import settings&#10;&#10;def setup_mysql():&#10;    try:&#10;        subprocess.run(['mysql', '--version'], check=True, capture_output=True)&#10;    except (subprocess.CalledProcessError, FileNotFoundError):&#10;        print(&quot;Please, install mysql and try again.&quot;)&#10;        sys.exit(1)&#10;&#10;    try:&#10;        subprocess.run(['systemctl', 'is-active', 'mysql'], check=True, capture_output=True)&#10;    except subprocess.CalledProcessError:&#10;        try:&#10;            subprocess.run(['systemctl', 'is-active', 'mariadb'], check=True, capture_output=True)&#10;        except subprocess.CalledProcessError:&#10;            print(&quot;MySQL/MariaDB server isn't running or doesn't exist. If it doesn't, install it and try again.&quot;)&#10;            sys.exit(1)&#10;&#10;    check_user_cmd = (f&quot;SELECT COUNT(*) FROM mysql.user WHERE user='{settings.MARIADB_USERNAME}' &quot;&#10;                      f&quot;AND host='{settings.MARIADB_SERVER}';&quot;)&#10;    result = subprocess.run([&#10;        'sudo', 'mysql', '-u', 'root', '-e', check_user_cmd&#10;    ], check=True, capture_output=True, text=True)&#10;&#10;    user_exists = '1' in result.stdout&#10;&#10;    if not user_exists:&#10;        create_user_commands = [&#10;            f&quot;CREATE USER '{settings.MARIADB_USERNAME}'@'{settings.MARIADB_SERVER}:{settings.MARIADB_PORT}'&quot;&#10;            f&quot; IDENTIFIED BY '{settings.MARIADB_PASSWORD}';&quot;,&#10;            &quot;GRANT ALL PRIVILEGES ON *.* TO &quot;&#10;            f&quot;'{settings.MARIADB_USERNAME}'@'{settings.MARIADB_SERVER}:{settings.MARIADB_PORT}';&quot;,&#10;            &quot;FLUSH PRIVILEGES;&quot;&#10;        ]&#10;&#10;        for cmd in create_user_commands:&#10;            try:&#10;                subprocess.run([&#10;                    'sudo', 'mysql', '-u', 'root', '-e', cmd&#10;                ], check=True, capture_output=True)&#10;            except Exception as e:&#10;                print(f&quot;There was a problem creating \&quot;{settings.MARIADB_USERNAME}\&quot;&quot;&#10;                      f&quot; user on mysql:\n{e}\n\nCommands used:\n&quot;&#10;                      f&quot;{'; '.join(create_user_commands)}&quot;)&#10;    return True" />
              <option name="updatedContent" value="import subprocess&#10;import sys&#10;from core.config_loader import settings&#10;&#10;def setup_mysql():&#10;    try:&#10;        subprocess.run(['mysql', '--version'], check=True, capture_output=True)&#10;    except (subprocess.CalledProcessError, FileNotFoundError):&#10;        print(&quot;Please, install mysql and try again.&quot;)&#10;        sys.exit(1)&#10;&#10;    try:&#10;        subprocess.run(['systemctl', 'is-active', 'mysql'], check=True, capture_output=True)&#10;    except subprocess.CalledProcessError:&#10;        try:&#10;            subprocess.run(['systemctl', 'is-active', 'mariadb'], check=True, capture_output=True)&#10;        except subprocess.CalledProcessError:&#10;            print(&quot;MySQL/MariaDB server isn't running or doesn't exist. If it doesn't, install it and try again.&quot;)&#10;            sys.exit(1)&#10;&#10;    check_user_cmd = (f&quot;SELECT COUNT(*) FROM mysql.user WHERE user='{settings.MARIADB_USERNAME}' &quot;&#10;                      f&quot;AND host='{settings.MARIADB_SERVER}';&quot;)&#10;    result = subprocess.run([&#10;        'sudo', 'mysql', '-u', 'root', '-e', check_user_cmd&#10;    ], check=True, capture_output=True, text=True)&#10;&#10;    user_exists = '1' in result.stdout&#10;&#10;    if not user_exists:&#10;        create_user_commands = [&#10;            f&quot;CREATE USER '{settings.MARIADB_USERNAME}'@'{settings.MARIADB_SERVER}:{settings.MARIADB_PORT}'&quot;&#10;            f&quot; IDENTIFIED BY '{settings.MARIADB_PASSWORD}';&quot;,&#10;            &quot;GRANT ALL PRIVILEGES ON *.* TO &quot;&#10;            f&quot;'{settings.MARIADB_USERNAME}'@'{settings.MARIADB_SERVER}:{settings.MARIADB_PORT}';&quot;,&#10;            &quot;FLUSH PRIVILEGES;&quot;&#10;        ]&#10;&#10;        for cmd in create_user_commands:&#10;            try:&#10;                subprocess.run([&#10;                    'sudo', 'mysql', '-u', 'root', '-e', cmd&#10;                ], check=True, capture_output=True)&#10;            except Exception as e:&#10;                print(f&quot;There was a problem creating \&quot;{settings.MARIADB_USERNAME}\&quot;&quot;&#10;                      f&quot; user on mysql:\n{e}\n\nCommands used:\n&quot;&#10;                      f&quot;{'; '.join(create_user_commands)}&quot;)&#10;    return True" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/__init__.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/__init__.py" />
              <option name="originalContent" value="from database.create import create_database&#10;if create_database():&#10;    from database.connection import engine, SessionLocal, Base&#10;&#10;" />
              <option name="updatedContent" value="from database.create import create_database&#10;if create_database():&#10;    from database.connection import engine, SessionLocal, Base&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/connection.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/connection.py" />
              <option name="originalContent" value="from sqlalchemy import create_engine&#10;from sqlalchemy.orm import sessionmaker, DeclarativeBase&#10;from core.config_loader import settings&#10;&#10;DATABASE_URL = str(settings.SQLALCHEMY_DATABASE_URI) #&quot;mysql+pymysql://raffles-manager:raffles@localhost/raffles_draw&quot;&#10;&#10;engine = create_engine(DATABASE_URL)&#10;SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)&#10;class Base(DeclarativeBase):&#10;    pass&#10;&#10;def get_db():&#10;    db = SessionLocal()&#10;    try:&#10;        yield db&#10;    finally:&#10;        db.close()" />
              <option name="updatedContent" value="from sqlalchemy import create_engine&#10;from sqlalchemy.orm import sessionmaker, DeclarativeBase&#10;from core.config_loader import settings&#10;&#10;# Create database URL but don't test connection during import&#10;DATABASE_URL = str(settings.SQLALCHEMY_DATABASE_URI)&#10;&#10;# Use pool settings to prevent hanging connections&#10;engine = create_engine(&#10;    DATABASE_URL,&#10;    pool_pre_ping=True,&#10;    pool_recycle=300,&#10;    connect_args={&quot;connect_timeout&quot;: 10}&#10;)&#10;SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)&#10;&#10;class Base(DeclarativeBase):&#10;    pass&#10;&#10;def get_db():&#10;    db = SessionLocal()&#10;    try:&#10;        yield db&#10;    finally:&#10;        db.close()" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/create-database-mysql.sql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/create-database-mysql.sql" />
              <option name="originalContent" value="-- MySQL Database Schema for Raffles Manager&#10;-- Mode: MySQL&#10;&#10;DROP DATABASE IF EXISTS raffles;&#10;CREATE DATABASE raffles;&#10;USE raffles;&#10;&#10;CREATE TABLE proyects (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    isActive BOOLEAN DEFAULT true&#10;);&#10;&#10;CREATE TABLE rafflesSet (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    proyect_id INTEGER,&#10;    name VARCHAR(100) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INTEGER NOT NULL,&#10;    final INTEGER NOT NULL,&#10;    unit_price INTEGER NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt; final),&#10;    CONSTRAINT unique_set UNIQUE (proyect_id, name),&#10;    FOREIGN KEY (proyect_id) REFERENCES proyects(id)&#10;);&#10;&#10;CREATE TABLE buyers (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    email VARCHAR(100) UNIQUE NOT NULL,&#10;    phone VARCHAR(20),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE raffles (&#10;    set_id INTEGER NOT NULL,&#10;    number INTEGER NOT NULL,&#10;    sell_date TIMESTAMP,&#10;    buyer_id INTEGER,&#10;    payment_method VARCHAR(50) CHECK (payment_method in ('CASH', 'CARD', 'TRANSFER', 'OTHER')),&#10;    state VARCHAR(20) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    FOREIGN KEY (set_id) REFERENCES rafflesSet(id),&#10;    PRIMARY KEY (set_id, number),&#10;    UNIQUE KEY unique_number (number)&#10;);&#10;&#10;-- Trigger to generate raffle numbers when a new raffleSet is created&#10;DELIMITER //&#10;CREATE TRIGGER generate_raffles&#10;    AFTER INSERT ON rafflesSet&#10;    FOR EACH ROW&#10;BEGIN&#10;    DECLARE i INT DEFAULT NEW.init;&#10;    WHILE i &lt;= NEW.final DO&#10;        INSERT INTO raffles (set_id, number) VALUES (NEW.id, i);&#10;        SET i = i + 1;&#10;    END WHILE;&#10;END//&#10;DELIMITER ;&#10;" />
              <option name="updatedContent" value="-- MySQL Database Schema for Raffles Manager&#10;-- Mode: MySQL&#10;&#10;DROP DATABASE IF EXISTS raffles;&#10;CREATE DATABASE raffles;&#10;USE raffles;&#10;&#10;CREATE TABLE proyects (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    isActive BOOLEAN DEFAULT true&#10;);&#10;&#10;CREATE TABLE rafflesSet (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    proyect_id INTEGER,&#10;    name VARCHAR(100) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INTEGER NOT NULL,&#10;    final INTEGER NOT NULL,&#10;    unit_price INTEGER NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt; final),&#10;    CONSTRAINT unique_set UNIQUE (proyect_id, name),&#10;    FOREIGN KEY (proyect_id) REFERENCES proyects(id)&#10;);&#10;&#10;CREATE TABLE buyers (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    email VARCHAR(100) UNIQUE NOT NULL,&#10;    phone VARCHAR(20),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE raffles (&#10;    set_id INTEGER NOT NULL,&#10;    number INTEGER NOT NULL,&#10;    sell_date TIMESTAMP,&#10;    buyer_id INTEGER,&#10;    payment_method VARCHAR(50) CHECK (payment_method in ('CASH', 'CARD', 'TRANSFER', 'OTHER')),&#10;    state VARCHAR(20) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    FOREIGN KEY (set_id) REFERENCES rafflesSet(id),&#10;    PRIMARY KEY (set_id, number),&#10;    UNIQUE KEY unique_number (number)&#10;);&#10;&#10;DELIMITER //&#10;CREATE TRIGGER generate_raffles&#10;    AFTER INSERT ON rafflesSet&#10;    FOR EACH ROW&#10;BEGIN&#10;    DECLARE i INT DEFAULT NEW.init;&#10;    WHILE i &lt;= NEW.final DO&#10;        INSERT INTO raffles (set_id, number) VALUES (NEW.id, i);&#10;        SET i = i + 1;&#10;    END WHILE;&#10;END//&#10;DELIMITER ;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/create-database.mysql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/create-database.mysql" />
              <option name="originalContent" value="-- @dialect mariadb&#10;&#10;DROP DATABASE raffles IF EXISTS;&#10;CREATE DATABASE raffles;&#10;USE raffles;&#10;&#10;CREATE TABLE proyects (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    isActive BOOLEAN DEFAULT true&#10;);&#10;&#10;CREATE TABLE rafflesSet (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    proyect_id INTEGER,&#10;    name VARCHAR(100) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INTEGER NOT NULL,&#10;    final INTEGER NOT NULL,&#10;    unit_price INTEGER NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt; final),&#10;    CONSTRAINT unique_set UNIQUE (proyect_id, name),&#10;    FOREIGN KEY (proyect_id) REFERENCES proyects(id)&#10;);&#10;&#10;CREATE TABLE buyers (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    email VARCHAR(100) UNIQUE NOT NULL,&#10;    phone VARCHAR(20),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE raffles (&#10;    set_id INTEGER NOT NULL,&#10;    number INTEGER NOT NULL,&#10;    sell_date TIMESTAMP,&#10;    buyer_id INTEGER,&#10;    payment_method VARCHAR(50) CHECK (payment_method in ('CASH', 'CARD', 'TRANSFER', 'OTHER')),&#10;    state VARCHAR(20) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    FOREIGN KEY (set_id) REFERENCES rafflesSet(id),&#10;    PRIMARY KEY (set_id, number),&#10;    UNIQUE KEY unique_number (number)&#10;);" />
              <option name="updatedContent" value="DROP DATABASE IF EXISTS raffles;&#10;CREATE DATABASE raffles;&#10;USE raffles;&#10;&#10;CREATE TABLE proyects (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    isActive BOOLEAN DEFAULT true&#10;);&#10;&#10;CREATE TABLE rafflesSet (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    proyect_id INTEGER,&#10;    name VARCHAR(100) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INTEGER NOT NULL,&#10;    final INTEGER NOT NULL,&#10;    unit_price INTEGER NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt; final),&#10;    CONSTRAINT unique_set UNIQUE (proyect_id, name),&#10;    FOREIGN KEY (proyect_id) REFERENCES proyects(id)&#10;);&#10;&#10;CREATE TABLE buyers (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    email VARCHAR(100) UNIQUE NOT NULL,&#10;    phone VARCHAR(20),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE raffles (&#10;    set_id INTEGER NOT NULL,&#10;    number INTEGER NOT NULL,&#10;    sell_date TIMESTAMP,&#10;    buyer_id INTEGER,&#10;    payment_method VARCHAR(50) CHECK (payment_method in ('CASH', 'CARD', 'TRANSFER', 'OTHER')),&#10;    state VARCHAR(20) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    FOREIGN KEY (set_id) REFERENCES rafflesSet(id),&#10;    PRIMARY KEY (set_id, number),&#10;    UNIQUE KEY unique_number (number)&#10;);&#10;&#10;-- Trigger to generate raffle numbers when a new raffleSet is created&#10;DELIMITER //&#10;CREATE TRIGGER generate_raffles&#10;    AFTER INSERT ON rafflesSet&#10;    FOR EACH ROW&#10;BEGIN&#10;    DECLARE i INT DEFAULT NEW.init;&#10;    WHILE i &lt;= NEW.final DO&#10;        INSERT INTO raffles (set_id, number) VALUES (NEW.id, i);&#10;        SET i = i + 1;&#10;    END WHILE;&#10;END//&#10;DELIMITER ;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/create.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/create.py" />
              <option name="originalContent" value="from sqlalchemy import text&#10;from core import sys_engine&#10;from pathlib import Path&#10;structure_path = Path(__file__).resolve().parent / &quot;structure.sql&quot;&#10;&#10;def db_exists(db: str):&#10;    with sys_engine.connect() as conn:&#10;        result = conn.execute(text(&quot;SHOW DATABASES&quot;))&#10;        databases = [row[0] for row in result]&#10;        return db in databases&#10;&#10;&#10;def create_database():&#10;    if not db_exists(&quot;raffles_draw&quot;):&#10;        with open(structure_path, 'r') as file:&#10;            sql_commands = file.read()&#10;&#10;        commands = [command.strip() for command in sql_commands.split(&quot;;&quot;) if command.strip()]&#10;        connection = sys_engine.connect()&#10;&#10;        for command in commands:&#10;            try:&#10;                connection.execute(text(command))&#10;                connection.commit()&#10;            except Exception as e:&#10;                print(f&quot;There was a problem creating \&quot;raffles_draw\&quot; database on mysql:\n{e}&quot;)&#10;    return True" />
              <option name="updatedContent" value="from sqlalchemy import text, create_engine&#10;from core.config_loader import settings&#10;from pathlib import Path&#10;&#10;structure_path = Path(__file__).resolve().parent / &quot;structure.sql&quot;&#10;&#10;def get_sys_engine():&#10;    &quot;&quot;&quot;Create system engine for database operations&quot;&quot;&quot;&#10;    return create_engine(f&quot;mysql+pymysql://{settings.MARIADB_USERNAME}:{settings.MARIADB_PASSWORD}@{settings.MARIADB_SERVER}&quot;)&#10;&#10;def db_exists(db: str):&#10;    sys_engine = get_sys_engine()&#10;    with sys_engine.connect() as conn:&#10;        result = conn.execute(text(&quot;SHOW DATABASES&quot;))&#10;        databases = [row[0] for row in result]&#10;        return db in databases&#10;&#10;&#10;def create_database():&#10;    if not db_exists(&quot;raffles_draw&quot;):&#10;        with open(structure_path, 'r') as file:&#10;            sql_commands = file.read()&#10;&#10;        commands = [command.strip() for command in sql_commands.split(&quot;;&quot;) if command.strip()]&#10;        sys_engine = get_sys_engine()&#10;        connection = sys_engine.connect()&#10;&#10;        for command in commands:&#10;            try:&#10;                connection.execute(text(command))&#10;                connection.commit()&#10;            except Exception as e:&#10;                print(f&quot;There was a problem creating \&quot;raffles_draw\&quot; database on mysql:\n{e}&quot;)&#10;        connection.close()&#10;    return True" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/structure.sql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/structure.sql" />
              <option name="originalContent" value="CREATE DATABASE IF NOT EXISTS raffles_draw;&#10;USE raffles_draw;&#10;&#10;CREATE TABLE IF NOT EXISTS users (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    username VARCHAR(32) NOT NULL UNIQUE,&#10;    email VARCHAR(64) NOT NULL UNIQUE,&#10;    password_hash TEXT NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    is_active BOOLEAN NOT NULL DEFAULT TRUE,&#10;    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS projects (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    user_id INT NOT NULL,&#10;    name VARCHAR(60) NOT NULL UNIQUE,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    is_active BOOLEAN DEFAULT TRUE,&#10;    FOREIGN KEY (user_id) REFERENCES users(id)&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS raffle_sets (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    project_id INT NOT NULL,&#10;    name VARCHAR(60) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INT NOT NULL,&#10;    final INT NOT NULL,&#10;    unit_price INT NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt;= final),&#10;    CONSTRAINT unique_set UNIQUE (project_id, name),&#10;    FOREIGN KEY (project_id) REFERENCES projects(id)&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS buyers (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(60) NOT NULL,&#10;    phone VARCHAR(20) NOT NULL,&#10;    email VARCHAR(64),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT unique_name_phone UNIQUE (name, phone)&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS raffles (&#10;    set_id INT NOT NULL,&#10;    number INT AUTO_INCREMENT PRIMARY KEY,&#10;    buyer_id INT,&#10;    sell_date TIMESTAMP,&#10;    payment_method VARCHAR(8) CHECK (payment_method in ('cash', 'card', 'transfer')),&#10;    state VARCHAR(9) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    FOREIGN KEY (set_id) REFERENCES raffle_sets(id)&#10;);&#10;" />
              <option name="updatedContent" value="CREATE DATABASE IF NOT EXISTS raffles_draw;&#10;USE raffles_draw;&#10;&#10;CREATE TABLE IF NOT EXISTS users (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    username VARCHAR(32) NOT NULL UNIQUE,&#10;    email VARCHAR(64) NOT NULL UNIQUE,&#10;    password_hash TEXT NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    is_active BOOLEAN NOT NULL DEFAULT TRUE,&#10;    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS projects (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    user_id INT NOT NULL,&#10;    name VARCHAR(60) NOT NULL UNIQUE,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    is_active BOOLEAN DEFAULT TRUE,&#10;    FOREIGN KEY (user_id) REFERENCES users(id)&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS raffle_sets (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    project_id INT NOT NULL,&#10;    name VARCHAR(60) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INT NOT NULL,&#10;    final INT NOT NULL,&#10;    unit_price INT NOT NULL,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt;= final),&#10;    CONSTRAINT unique_set UNIQUE (project_id, name),&#10;    FOREIGN KEY (project_id) REFERENCES projects(id)&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS buyers (&#10;    id INT AUTO_INCREMENT PRIMARY KEY,&#10;    name VARCHAR(60) NOT NULL,&#10;    phone VARCHAR(20) NOT NULL,&#10;    email VARCHAR(64),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT unique_name_phone UNIQUE (name, phone)&#10;);&#10;&#10;CREATE TABLE IF NOT EXISTS raffles (&#10;    number INT PRIMARY KEY,&#10;    set_id INT NOT NULL,&#10;    buyer_id INT,&#10;    sell_date TIMESTAMP,&#10;    payment_method VARCHAR(8) CHECK (payment_method in ('cash', 'card', 'transfer')),&#10;    state VARCHAR(9) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    FOREIGN KEY (set_id) REFERENCES raffle_sets(id)&#10;);" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database/test_database.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database/test_database.py" />
              <option name="updatedContent" value="#!/usr/bin/env python3&#10;        print(&quot;❌ Some tests failed. Please check the database setup.&quot;)&#10;        sys.exit(1)&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    main()" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/models/__init__.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/models/__init__.py" />
              <option name="originalContent" value="from .project import Project&#10;from .raffle import Raffle&#10;from .raffleset import RaffleSet&#10;from .buyer import Buyer&#10;from .users import Users&#10;&#10;__all__ = [&quot;Project&quot;, &quot;RaffleSet&quot;, &quot;Raffle&quot;, &quot;Buyer&quot;, &quot;Users&quot;]" />
              <option name="updatedContent" value="from .project import Project&#10;from .raffle import Raffle&#10;from .raffleset import RaffleSet&#10;from .buyer import Buyer&#10;from .users import User&#10;&#10;__all__ = [&quot;Project&quot;, &quot;RaffleSet&quot;, &quot;Raffle&quot;, &quot;Buyer&quot;, &quot;User&quot;]" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/models/buyer.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/models/buyer.py" />
              <option name="originalContent" value="from sqlalchemy import Column, Integer, String, TIMESTAMP, UniqueConstraint&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class Buyer(Base):&#10;    __tablename__ = &quot;buyers&quot;&#10;&#10;    id = Column(Integer, primary_key=True)&#10;    name = Column(String(60), nullable=False)&#10;    phone = Column(String(20), nullable=False)&#10;    email = Column(String(64))&#10;    register_date = Column(TIMESTAMP, server_default=&quot;CURRENT_TIMESTAMP&quot;)&#10;&#10;    __table_args__ = (&#10;        UniqueConstraint('name', 'phone', name='unique_name_phone'),&#10;    )&#10;&#10;    raffles = relationship(&quot;Raffle&quot;, back_populates=&quot;buyer&quot;)&#10;" />
              <option name="updatedContent" value="from sqlalchemy import Column, Integer, String, TIMESTAMP, UniqueConstraint, text&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class Buyer(Base):&#10;    __tablename__ = &quot;buyers&quot;&#10;&#10;    id = Column(Integer, primary_key=True)&#10;    name = Column(String(60), nullable=False)&#10;    phone = Column(String(20), nullable=False)&#10;    email = Column(String(64))&#10;    register_date = Column(TIMESTAMP, server_default=text(&quot;CURRENT_TIMESTAMP&quot;))&#10;&#10;    __table_args__ = (&#10;        UniqueConstraint('name', 'phone', name='unique_name_phone'),&#10;    )&#10;&#10;    raffles = relationship(&quot;Raffle&quot;, back_populates=&quot;buyer&quot;)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/models/project.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/models/project.py" />
              <option name="originalContent" value="from sqlalchemy import Column, Integer, String, Text, Boolean, TIMESTAMP, ForeignKey&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class Project(Base):&#10;    __tablename__ = &quot;projects&quot;&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    user_id = Column(Integer, ForeignKey(&quot;users.id&quot;), nullable=False)&#10;    name = Column(String(60), nullable=False, unique=True)&#10;    description = Column(Text)&#10;    creation_date = Column(TIMESTAMP, server_default=&quot;CURRENT_TIMESTAMP&quot;)&#10;    is_active = Column(Boolean, default=True)&#10;&#10;    raffle_sets = relationship(&quot;RaffleSet&quot;, back_populates=&quot;project&quot;)&#10;    user = relationship(&quot;User&quot;, back_populates=&quot;projects&quot;)&#10;" />
              <option name="updatedContent" value="from sqlalchemy import Column, Integer, String, Text, Boolean, TIMESTAMP, ForeignKey, text&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class Project(Base):&#10;    __tablename__ = &quot;projects&quot;&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    user_id = Column(Integer, ForeignKey(&quot;users.id&quot;), nullable=False)&#10;    name = Column(String(60), nullable=False, unique=True)&#10;    description = Column(Text)&#10;    creation_date = Column(TIMESTAMP, server_default=text(&quot;CURRENT_TIMESTAMP&quot;))&#10;    is_active = Column(Boolean, default=True)&#10;&#10;    raffle_sets = relationship(&quot;RaffleSet&quot;, back_populates=&quot;project&quot;)&#10;    user = relationship(&quot;User&quot;, back_populates=&quot;projects&quot;)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/models/raffle.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/models/raffle.py" />
              <option name="originalContent" value="from sqlalchemy import Column, Integer, String, ForeignKey, TIMESTAMP&#10;from sqlalchemy.orm import relationship&#10;from database import Base&#10;&#10;&#10;class Raffle(Base):&#10;    __tablename__ = &quot;raffles&quot;&#10;    number = Column(Integer, primary_key=True)&#10;    set_id = Column(Integer, ForeignKey(&quot;raffle_sets.id&quot;), nullable=False)&#10;    buyer_id = Column(Integer, ForeignKey(&quot;buyers.id&quot;))&#10;    sell_date = Column(TIMESTAMP)&#10;    payment_method = Column(String(8))&#10;    state = Column(String(9), default=&quot;available&quot;)&#10;&#10;    raffle_set = relationship(&quot;RaffleSet&quot;, back_populates=&quot;raffles&quot;)&#10;    buyer = relationship(&quot;Buyer&quot;, back_populates=&quot;raffles&quot;)&#10;" />
              <option name="updatedContent" value="from sqlalchemy import Column, Integer, String, ForeignKey, TIMESTAMP&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class Raffle(Base):&#10;    __tablename__ = &quot;raffles&quot;&#10;    number = Column(Integer, primary_key=True)&#10;    set_id = Column(Integer, ForeignKey(&quot;raffle_sets.id&quot;), nullable=False)&#10;    buyer_id = Column(Integer, ForeignKey(&quot;buyers.id&quot;))&#10;    sell_date = Column(TIMESTAMP)&#10;    payment_method = Column(String(8))&#10;    state = Column(String(9), default=&quot;available&quot;)&#10;&#10;    raffle_set = relationship(&quot;RaffleSet&quot;, back_populates=&quot;raffles&quot;)&#10;    buyer = relationship(&quot;Buyer&quot;, back_populates=&quot;raffles&quot;)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/models/raffleset.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/models/raffleset.py" />
              <option name="originalContent" value="from sqlalchemy import Column, Integer, String, TIMESTAMP, ForeignKey, CheckConstraint&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class RaffleSet(Base):&#10;    __tablename__ = &quot;raffle_sets&quot;&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    project_id = Column(Integer, ForeignKey(&quot;projects.id&quot;), nullable=False)&#10;    name = Column(String(60), nullable=False)&#10;    type = Column(String(8), nullable=False)&#10;    init = Column(Integer, nullable=False)&#10;    final = Column(Integer, nullable=False)&#10;    unit_price = Column(Integer, nullable=False)&#10;    creation_date = Column(TIMESTAMP, server_default=&quot;CURRENT_TIMESTAMP&quot;)&#10;&#10;    __table_args__ = (&#10;        CheckConstraint(&quot;init &lt; final&quot;, name=&quot;valid_numbers&quot;),&#10;    )&#10;&#10;    project = relationship(&quot;Project&quot;, back_populates=&quot;raffle_sets&quot;)&#10;    raffles = relationship(&quot;Raffle&quot;, back_populates=&quot;raffle_set&quot;)" />
              <option name="updatedContent" value="from sqlalchemy import Column, Integer, String, TIMESTAMP, ForeignKey, CheckConstraint, text&#10;from sqlalchemy.orm import relationship&#10;from database.connection import Base&#10;&#10;&#10;class RaffleSet(Base):&#10;    __tablename__ = &quot;raffle_sets&quot;&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    project_id = Column(Integer, ForeignKey(&quot;projects.id&quot;), nullable=False)&#10;    name = Column(String(60), nullable=False)&#10;    type = Column(String(8), nullable=False)&#10;    init = Column(Integer, nullable=False)&#10;    final = Column(Integer, nullable=False)&#10;    unit_price = Column(Integer, nullable=False)&#10;    creation_date = Column(TIMESTAMP, server_default=text(&quot;CURRENT_TIMESTAMP&quot;))&#10;&#10;    __table_args__ = (&#10;        CheckConstraint(&quot;init &lt; final&quot;, name=&quot;valid_numbers&quot;),&#10;    )&#10;&#10;    project = relationship(&quot;Project&quot;, back_populates=&quot;raffle_sets&quot;)&#10;    raffles = relationship(&quot;Raffle&quot;, back_populates=&quot;raffle_set&quot;)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/models/users.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/models/users.py" />
              <option name="originalContent" value="from sqlalchemy.orm import Mapped, mapped_column, relationship&#10;from sqlalchemy import Integer, String, Boolean, DateTime, text&#10;from database.connection import Base&#10;from datetime import datetime, timezone&#10;&#10;&#10;class User(Base):&#10;    __tablename__ = 'users'&#10;&#10;    id: Mapped[int] = mapped_column(Integer, primary_key=True)&#10;    username: Mapped[str] = mapped_column(String(32), unique=True, nullable=False)&#10;    email: Mapped[str] = mapped_column(String(64), unique=True, nullable=False)&#10;    password: Mapped[str] = mapped_column(String(128), nullable=False)&#10;    is_active: Mapped[bool] = mapped_column(Boolean, default=True)&#10;    created_at: Mapped[DateTime] = mapped_column(DateTime, server_default=text(&quot;CURRENT_TIMESTAMP&quot;), nullable=False)&#10;    updated_at: Mapped[DateTime] = mapped_column(DateTime, server_default=text(&quot;CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP&quot;))&#10;&#10;    projects = relationship(&quot;Project&quot;, back_populates=&quot;user&quot;)&#10;" />
              <option name="updatedContent" value="from sqlalchemy.orm import Mapped, mapped_column, relationship&#10;from sqlalchemy import Integer, String, Boolean, DateTime, text&#10;from database.connection import Base&#10;from datetime import datetime, timezone&#10;&#10;&#10;class User(Base):&#10;    __tablename__ = 'users'&#10;&#10;    id: Mapped[int] = mapped_column(Integer, primary_key=True)&#10;    username: Mapped[str] = mapped_column(String(32), unique=True, nullable=False)&#10;    email: Mapped[str] = mapped_column(String(64), unique=True, nullable=False)&#10;    password_hash: Mapped[str] = mapped_column(String(128), nullable=False)  # Fixed to match SQL&#10;    is_active: Mapped[bool] = mapped_column(Boolean, default=True)&#10;    creation_date: Mapped[DateTime] = mapped_column(DateTime, server_default=text(&quot;CURRENT_TIMESTAMP&quot;), nullable=False)  # Fixed field name&#10;    updated_at: Mapped[DateTime] = mapped_column(DateTime, server_default=text(&quot;CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP&quot;))&#10;&#10;    projects = relationship(&quot;Project&quot;, back_populates=&quot;user&quot;)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/routes/__init__.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/routes/__init__.py" />
              <option name="originalContent" value="from fastapi import HTTPException&#10;&#10;&#10;def get_record(db, Model, _id, model_name):&#10;    record = db.query(Model).filter(Model.id == _id).first()&#10;    if not record:&#10;        raise HTTPException(status_code=404, detail=f&quot;{model_name} not found&quot;)&#10;    return record" />
              <option name="updatedContent" value="from fastapi import HTTPException&#10;&#10;&#10;def get_record(db, Model, _id, model_name, id_field=&quot;id&quot;):&#10;    &quot;&quot;&quot;Get a record by ID or custom field name.&quot;&quot;&quot;&#10;    if id_field == &quot;id&quot;:&#10;        record = db.query(Model).filter(Model.id == _id).first()&#10;    elif id_field == &quot;number&quot;:&#10;        record = db.query(Model).filter(Model.number == _id).first()&#10;    else:&#10;        # Generic approach for other field names&#10;        field = getattr(Model, id_field)&#10;        record = db.query(Model).filter(field == _id).first()&#10;    &#10;    if not record:&#10;        raise HTTPException(status_code=404, detail=f&quot;{model_name} not found&quot;)&#10;    return record" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/routes/buyer.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/routes/buyer.py" />
              <option name="originalContent" value="from fastapi import APIRouter, Depends, HTTPException, Query&#10;from sqlalchemy.exc import IntegrityError&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models.buyer import Buyer&#10;from routes import get_record&#10;from schemas.buyer import BuyerCreate, BuyerDelete, BuyerUpdate&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.post(&quot;/buyer&quot;)&#10;def create_buyer(buyer: BuyerCreate, db: Session = Depends(get_db)):&#10;    new_buyer = Buyer(&#10;        name=buyer.name,&#10;        phone=buyer.phone,&#10;        email=str(buyer.email)&#10;    )&#10;&#10;    db.add(new_buyer)&#10;    try:&#10;        db.commit()&#10;    except IntegrityError:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;There's already a buyer with that name and phone.&quot;&#10;        )&#10;&#10;    db.refresh(new_buyer)&#10;    return {&#10;        &quot;id&quot;: new_buyer.id,&#10;        &quot;name&quot;: new_buyer.name,&#10;        &quot;email&quot;: new_buyer.email,&#10;        &quot;phone&quot;: new_buyer.phone&#10;    }&#10;&#10;&#10;@router.get(&quot;/buyer&quot;)&#10;def get_buyer(&#10;    id: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    return get_record(db, Buyer, id, &quot;Buyer&quot;)&#10;&#10;&#10;@router.get(&quot;/buyers&quot;)&#10;def get_buyers(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(Buyer).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(Buyer).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.patch(&quot;/buyer&quot;)&#10;@router.put(&quot;/buyer&quot;)&#10;def update_buyer(&#10;    updates: BuyerUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    buyer_record = get_record(db, Buyer, updates.id, &quot;Buyer&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(buyer_record, field, value)&#10;    &#10;    db.commit()&#10;    db.refresh(buyer_record)&#10;    return buyer_record&#10;&#10;&#10;@router.delete(&quot;/buyer&quot;)&#10;def delete_buyer(buyer: BuyerDelete, db: Session = Depends(get_db)):&#10;    if buyer.id:&#10;        buyer_record = buyer_record = get_record(db, Buyer, id, &quot;Buyer&quot;)&#10;        db.delete(buyer_record)&#10;        db.commit()&#10;        return {&quot;message&quot;: &quot;Buyer deleted successfully&quot;}&#10;    else:&#10;        buyer_record = db.query(Buyer).filter(&#10;            (Buyer.name == buyer.name) &amp; (Buyer.phone == buyer.phone)&#10;        ).first()&#10;        if not buyer_record:&#10;            raise HTTPException(&#10;                status_code=404,&#10;                detail=&quot;There isn't any buyer with that pair of name and number.&quot;&#10;            )&#10;        db.delete(buyer_record)&#10;        db.commit()&#10;        return {&quot;message&quot;: &quot;Buyer deleted successfully&quot;}" />
              <option name="updatedContent" value="from fastapi import APIRouter, Depends, HTTPException, Query&#10;from sqlalchemy.exc import IntegrityError&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models.buyer import Buyer&#10;from routes import get_record&#10;from schemas.buyer import BuyerCreate, BuyerDelete, BuyerUpdate&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.post(&quot;/buyer&quot;)&#10;def create_buyer(buyer: BuyerCreate, db: Session = Depends(get_db)):&#10;    new_buyer = Buyer(&#10;        name=buyer.name,&#10;        phone=buyer.phone,&#10;        email=str(buyer.email)&#10;    )&#10;&#10;    db.add(new_buyer)&#10;    try:&#10;        db.commit()&#10;    except IntegrityError:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;There's already a buyer with that name and phone.&quot;&#10;        )&#10;&#10;    db.refresh(new_buyer)&#10;    return {&#10;        &quot;id&quot;: new_buyer.id,&#10;        &quot;name&quot;: new_buyer.name,&#10;        &quot;email&quot;: new_buyer.email,&#10;        &quot;phone&quot;: new_buyer.phone&#10;    }&#10;&#10;&#10;@router.get(&quot;/buyer&quot;)&#10;def get_buyer(&#10;    id: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    return get_record(db, Buyer, id, &quot;Buyer&quot;)&#10;&#10;&#10;@router.get(&quot;/buyers&quot;)&#10;def get_buyers(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(Buyer).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(Buyer).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.patch(&quot;/buyer&quot;)&#10;@router.put(&quot;/buyer&quot;)&#10;def update_buyer(&#10;    updates: BuyerUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    buyer_record = get_record(db, Buyer, updates.id, &quot;Buyer&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(buyer_record, field, value)&#10;    &#10;    db.commit()&#10;    db.refresh(buyer_record)&#10;    return buyer_record&#10;&#10;&#10;@router.delete(&quot;/buyer&quot;)&#10;def delete_buyer(buyer: BuyerDelete, db: Session = Depends(get_db)):&#10;    if buyer.id:&#10;        buyer_record = get_record(db, Buyer, buyer.id, &quot;Buyer&quot;)&#10;        db.delete(buyer_record)&#10;        db.commit()&#10;        return {&quot;message&quot;: &quot;Buyer deleted successfully&quot;}&#10;    else:&#10;        buyer_record = db.query(Buyer).filter(&#10;            (Buyer.name == buyer.name) &amp; (Buyer.phone == buyer.phone)&#10;        ).first()&#10;        if not buyer_record:&#10;            raise HTTPException(&#10;                status_code=404,&#10;                detail=&quot;There isn't any buyer with that pair of name and number.&quot;&#10;            )&#10;        db.delete(buyer_record)&#10;        db.commit()&#10;        return {&quot;message&quot;: &quot;Buyer deleted successfully&quot;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/routes/project.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/routes/project.py" />
              <option name="originalContent" value="from fastapi import APIRouter, Depends, HTTPException, Query&#10;from sqlalchemy.exc import IntegrityError&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models import RaffleSet, Raffle&#10;from models.project import Project&#10;from routes import get_record&#10;from schemas.project import ProjectCreate, ProjectUpdate&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.post(&quot;/project&quot;)&#10;def create_project(project: ProjectCreate, db: Session = Depends(get_db)):&#10;    new_project = Project(&#10;        name=project.name,&#10;        description=project.description&#10;    )&#10;    &#10;    db.add(new_project)&#10;    try:&#10;        db.commit()&#10;    except IntegrityError:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;There's already a project with that name.&quot;&#10;        )&#10;    &#10;    db.refresh(new_project)&#10;    return new_project&#10;&#10;&#10;@router.get(&quot;/project&quot;)&#10;def get_project(&#10;    id: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    return get_record(db, Project, id, &quot;Project&quot;)&#10;&#10;@router.get(&quot;/projects&quot;)&#10;def get_projects(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(Project).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(Project).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.patch(&quot;/project&quot;)&#10;@router.put(&quot;/project&quot;)&#10;def update_project(&#10;    updates: ProjectUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    project_record = get_record(db, Project, updates.id, &quot;Project&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(project_record, field, value)&#10;    &#10;    db.commit()&#10;    db.refresh(project_record)&#10;    return project_record&#10;&#10;&#10;@router.delete(&quot;/project&quot;)&#10;def delete_project(&#10;    id: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    project_record = get_record(db, Project, id, &quot;Project&quot;)&#10;    &#10;    # Delete rafflesets and raffles associated with the project&#10;    rafflesets = db.query(RaffleSet).filter(RaffleSet.project_id == id).all()&#10;    sets_ids = [set.id for set in rafflesets]&#10;    &#10;    for set_id in sets_ids:&#10;        db.query(Raffle).filter(Raffle.set_id == set_id).delete()&#10;    &#10;    for raffleset in rafflesets:&#10;        db.delete(raffleset)&#10;&#10;    db.delete(project_record)&#10;    db.commit()&#10;    return {&quot;message&quot;: &quot;Project, rafflesets and raffles associated with it, deleted successfully&quot;}" />
              <option name="updatedContent" value="from fastapi import APIRouter, Depends, HTTPException, Query&#10;from sqlalchemy.exc import IntegrityError&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models import RaffleSet, Raffle&#10;from models.project import Project&#10;from routes import get_record&#10;from schemas.project import ProjectCreate, ProjectUpdate&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.post(&quot;/project&quot;)&#10;def create_project(project: ProjectCreate, db: Session = Depends(get_db)):&#10;    new_project = Project(&#10;        name=project.name,&#10;        description=project.description,&#10;        user_id=1  # TODO: Replace with actual user ID from authentication&#10;    )&#10;    &#10;    db.add(new_project)&#10;    try:&#10;        db.commit()&#10;    except IntegrityError:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;There's already a project with that name.&quot;&#10;        )&#10;    &#10;    db.refresh(new_project)&#10;    return new_project&#10;&#10;&#10;@router.get(&quot;/project&quot;)&#10;def get_project(&#10;    id: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    return get_record(db, Project, id, &quot;Project&quot;)&#10;&#10;@router.get(&quot;/projects&quot;)&#10;def get_projects(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(Project).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(Project).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.patch(&quot;/project&quot;)&#10;@router.put(&quot;/project&quot;)&#10;def update_project(&#10;    updates: ProjectUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    project_record = get_record(db, Project, updates.id, &quot;Project&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(project_record, field, value)&#10;    &#10;    db.commit()&#10;    db.refresh(project_record)&#10;    return project_record&#10;&#10;&#10;@router.delete(&quot;/project&quot;)&#10;def delete_project(&#10;    id: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    project_record = get_record(db, Project, id, &quot;Project&quot;)&#10;    &#10;    # Delete rafflesets and raffles associated with the project&#10;    rafflesets = db.query(RaffleSet).filter(RaffleSet.project_id == id).all()&#10;    sets_ids = [set.id for set in rafflesets]&#10;    &#10;    for set_id in sets_ids:&#10;        db.query(Raffle).filter(Raffle.set_id == set_id).delete()&#10;    &#10;    for raffleset in rafflesets:&#10;        db.delete(raffleset)&#10;&#10;    db.delete(project_record)&#10;    db.commit()&#10;    return {&quot;message&quot;: &quot;Project, rafflesets and raffles associated with it, deleted successfully&quot;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/routes/raffle.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/routes/raffle.py" />
              <option name="originalContent" value="from datetime import datetime&#10;from fastapi import APIRouter, Depends, HTTPException, Query&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models.raffle import Raffle&#10;from routes import get_record&#10;from schemas.raffle import RaffleUpdate, RafflePayment&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.get(&quot;/raffle&quot;)&#10;def get_raffle(&#10;    number: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffle_record = get_record(db, Raffle, number, &quot;Raffle&quot;)&#10;    return raffle_record&#10;&#10;&#10;@router.get(&quot;/raffles&quot;)&#10;def get_raffles(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(Raffle).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(Raffle).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.post(&quot;/raffle/pay&quot;)&#10;def pay_raffle(&#10;    payment: RafflePayment,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffle_record = get_record(db, Raffle, payment.number, &quot;Raffle&quot;) #db.query(Raffle).filter(Raffle.number == payment.number).first()&#10;&#10;    if raffle_record.state != &quot;available&quot;:&#10;        raise HTTPException(status_code=400, detail=&quot;Raffle is not available for payment&quot;)&#10;&#10;    raffle_record.buyer_id = payment.buyer_id&#10;    raffle_record.payment_method = payment.payment_method&#10;    raffle_record.state = payment.state&#10;    raffle_record.sell_date = datetime.now()&#10;&#10;    db.commit()&#10;    db.refresh(raffle_record)&#10;    return raffle_record&#10;&#10;&#10;@router.patch(&quot;/raffle&quot;)&#10;@router.put(&quot;/raffle&quot;) # PUT should be used for fully updates, but I will use it like PATCH for compatibility.&#10;def update_raffle(&#10;    updates: RaffleUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffle_record = get_record(db, Raffle, updates.number, &quot;Raffle&quot;) #db.query(Raffle).filter(Raffle.number == updates.number).first()&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(raffle_record, field, value)&#10;&#10;    db.commit()&#10;    db.refresh(raffle_record)&#10;    return raffle_record&#10;" />
              <option name="updatedContent" value="from datetime import datetime&#10;from fastapi import APIRouter, Depends, HTTPException, Query&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models.raffle import Raffle&#10;from routes import get_record&#10;from schemas.raffle import RaffleUpdate, RafflePayment&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.get(&quot;/raffle&quot;)&#10;def get_raffle(&#10;    number: int = Query(..., ge=1),&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffle_record = get_record(db, Raffle, number, &quot;Raffle&quot;, id_field=&quot;number&quot;)&#10;    return raffle_record&#10;&#10;&#10;@router.get(&quot;/raffles&quot;)&#10;def get_raffles(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(Raffle).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(Raffle).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.post(&quot;/raffle/pay&quot;)&#10;def pay_raffle(&#10;    payment: RafflePayment,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffle_record = get_record(db, Raffle, payment.number, &quot;Raffle&quot;, id_field=&quot;number&quot;)&#10;&#10;    if raffle_record.state != &quot;available&quot;:&#10;        raise HTTPException(status_code=400, detail=&quot;Raffle is not available for payment&quot;)&#10;&#10;    raffle_record.buyer_id = payment.buyer_id&#10;    raffle_record.payment_method = payment.payment_method&#10;    raffle_record.state = payment.state&#10;    raffle_record.sell_date = datetime.now()&#10;&#10;    db.commit()&#10;    db.refresh(raffle_record)&#10;    return raffle_record&#10;&#10;&#10;@router.patch(&quot;/raffle&quot;)&#10;@router.put(&quot;/raffle&quot;) # PUT should be used for fully updates, but I will use it like PATCH for compatibility.&#10;def update_raffle(&#10;    updates: RaffleUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffle_record = get_record(db, Raffle, updates.number, &quot;Raffle&quot;, id_field=&quot;number&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(raffle_record, field, value)&#10;&#10;    db.commit()&#10;    db.refresh(raffle_record)&#10;    return raffle_record" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/routes/raffleset.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/routes/raffleset.py" />
              <option name="originalContent" value="from fastapi import APIRouter, Depends, HTTPException&#10;from sqlalchemy.exc import IntegrityError&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models import RaffleSet, Raffle&#10;from routes import get_record&#10;from schemas.raffleset import RaffleSetCreate, RaffleSetUpdate&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.post(&quot;/raffleset&quot;)&#10;def create_raffleset(&#10;    raffleset: RaffleSetCreate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    # Find the last raffle number for this specific project (across all sets)&#10;    last_number = (&#10;        db.query(Raffle.number)&#10;        .join(RaffleSet)&#10;        .filter(RaffleSet.project_id == raffleset.project_id)&#10;        .order_by(Raffle.number.desc())&#10;        .limit(1)&#10;        .scalar()&#10;    )&#10;&#10;    start = (last_number or 0) + 1&#10;    end = start + raffleset.requested_count - 1&#10;&#10;    new_raffleset = RaffleSet(&#10;        project_id=raffleset.project_id,&#10;        name=raffleset.name,&#10;        type=raffleset.type,&#10;        unit_price=raffleset.unit_price,&#10;        init=start,&#10;        final=end&#10;    )&#10;&#10;    db.add(new_raffleset)&#10;    try:&#10;        db.commit()&#10;    except IntegrityError:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Raffle set already exists&quot;&#10;        )&#10;    db.refresh(new_raffleset)&#10;&#10;    raffles = [&#10;        Raffle(&#10;            number=n,&#10;            set_id=new_raffleset.id,&#10;            state=&quot;available&quot;&#10;        )&#10;        for n in range(start, end + 1)&#10;    ]&#10;    db.bulk_save_objects(raffles)&#10;    db.commit()&#10;&#10;    return {&#10;        &quot;message&quot;: &quot;RaffleSet and Raffles created&quot;,&#10;        &quot;raffleset&quot;: new_raffleset,&#10;        &quot;range&quot;: f&quot;{start}-{end}&quot;&#10;    }&#10;&#10;&#10;@router.get(&quot;/raffleset/{id}&quot;)&#10;def get_raffleset(&#10;    id: int,&#10;    db: Session = Depends(get_db)&#10;):&#10;    return get_record(db, RaffleSet, id, &quot;Raffle Set&quot;)&#10;&#10;@router.get(&quot;/rafflesets&quot;)&#10;def get_rafflesets(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(RaffleSet).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(RaffleSet).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.patch(&quot;/raffleset/{id}&quot;)&#10;@router.put(&quot;/raffleset/{id}&quot;)&#10;def update_raffleset(&#10;    updates: RaffleSetUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffleset_record = get_record(db, RaffleSet, updates.id, &quot;Raffle Set&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(raffleset_record, field, value)&#10;&#10;    db.commit()&#10;    db.refresh(raffleset_record)&#10;    return raffleset_record&#10;&#10;&#10;@router.delete(&quot;/raffleset/{id}&quot;)&#10;def delete_raffleset(&#10;    id: int,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffleset_record = db.query(RaffleSet).filter(RaffleSet.id == id).first()&#10;    if not raffleset_record:&#10;        raise HTTPException(status_code=404, detail=&quot;RaffleSet not found&quot;)&#10;&#10;    db.query(Raffle).filter(Raffle.set_id == id).delete()&#10;    db.delete(raffleset_record)&#10;    try:&#10;        db.commit()&#10;    except Exception as e:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;RaffleSet cannot be deleted. Error: &quot; + str(e)&#10;        )&#10;    return {&quot;message&quot;: &quot;RaffleSet and its raffles deleted successfully&quot;}&#10;" />
              <option name="updatedContent" value="from fastapi import APIRouter, Depends, HTTPException&#10;from sqlalchemy.exc import IntegrityError&#10;from sqlalchemy.orm import Session&#10;from database.connection import get_db&#10;from models import RaffleSet, Raffle&#10;from routes import get_record&#10;from schemas.raffleset import RaffleSetCreate, RaffleSetUpdate&#10;&#10;router = APIRouter()&#10;&#10;&#10;@router.post(&quot;/raffleset&quot;)&#10;def create_raffleset(&#10;    raffleset: RaffleSetCreate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    # Find the last raffle number for this specific project (across all sets)&#10;    last_number = (&#10;        db.query(Raffle.number)&#10;        .join(RaffleSet)&#10;        .filter(RaffleSet.project_id == raffleset.project_id)&#10;        .order_by(Raffle.number.desc())&#10;        .limit(1)&#10;        .scalar()&#10;    )&#10;&#10;    start = (last_number or 0) + 1&#10;    end = start + raffleset.requested_count - 1&#10;&#10;    new_raffleset = RaffleSet(&#10;        project_id=raffleset.project_id,&#10;        name=raffleset.name,&#10;        type=raffleset.type,&#10;        unit_price=raffleset.unit_price,&#10;        init=start,&#10;        final=end&#10;    )&#10;&#10;    db.add(new_raffleset)&#10;    try:&#10;        db.commit()&#10;    except IntegrityError:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Raffle set already exists&quot;&#10;        )&#10;    db.refresh(new_raffleset)&#10;&#10;    raffles = [&#10;        Raffle(&#10;            number=n,&#10;            set_id=new_raffleset.id,&#10;            state=&quot;available&quot;&#10;        )&#10;        for n in range(start, end + 1)&#10;    ]&#10;    db.bulk_save_objects(raffles)&#10;    db.commit()&#10;&#10;    return {&#10;        &quot;message&quot;: &quot;RaffleSet and Raffles created&quot;,&#10;        &quot;raffleset&quot;: {&#10;            &quot;id&quot;: new_raffleset.id,&#10;            &quot;name&quot;: new_raffleset.name,&#10;            &quot;type&quot;: new_raffleset.type,&#10;            &quot;init&quot;: new_raffleset.init,&#10;            &quot;final&quot;: new_raffleset.final,&#10;            &quot;unit_price&quot;: new_raffleset.unit_price,&#10;            &quot;project_id&quot;: new_raffleset.project_id&#10;        },&#10;        &quot;range&quot;: f&quot;{start}-{end}&quot;&#10;    }&#10;&#10;&#10;@router.get(&quot;/raffleset/{id}&quot;)&#10;def get_raffleset(&#10;    id: int,&#10;    db: Session = Depends(get_db)&#10;):&#10;    return get_record(db, RaffleSet, id, &quot;Raffle Set&quot;)&#10;&#10;@router.get(&quot;/rafflesets&quot;)&#10;def get_rafflesets(&#10;    limit: int = 0,&#10;    db: Session = Depends(get_db)&#10;):&#10;    if limit &gt; 0:&#10;        return db.query(RaffleSet).limit(limit).all()&#10;    elif limit == 0:&#10;        return db.query(RaffleSet).all()&#10;    else:&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;Limit must be a non-negative integer.&quot;&#10;        )&#10;&#10;&#10;@router.patch(&quot;/raffleset/{id}&quot;)&#10;@router.put(&quot;/raffleset/{id}&quot;)&#10;def update_raffleset(&#10;    updates: RaffleSetUpdate,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffleset_record = get_record(db, RaffleSet, updates.id, &quot;Raffle Set&quot;)&#10;&#10;    for field, value in updates.model_dump(exclude_unset=True).items():&#10;        setattr(raffleset_record, field, value)&#10;&#10;    db.commit()&#10;    db.refresh(raffleset_record)&#10;    return raffleset_record&#10;&#10;&#10;@router.delete(&quot;/raffleset/{id}&quot;)&#10;def delete_raffleset(&#10;    id: int,&#10;    db: Session = Depends(get_db)&#10;):&#10;    raffleset_record = db.query(RaffleSet).filter(RaffleSet.id == id).first()&#10;    if not raffleset_record:&#10;        raise HTTPException(status_code=404, detail=&quot;RaffleSet not found&quot;)&#10;&#10;    db.query(Raffle).filter(Raffle.set_id == id).delete()&#10;    db.delete(raffleset_record)&#10;    try:&#10;        db.commit()&#10;    except Exception as e:&#10;        db.rollback()&#10;        raise HTTPException(&#10;            status_code=400,&#10;            detail=&quot;RaffleSet cannot be deleted. Error: &quot; + str(e)&#10;        )&#10;    return {&quot;message&quot;: &quot;RaffleSet and its raffles deleted successfully&quot;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/schemas/buyer.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/schemas/buyer.py" />
              <option name="originalContent" value="from pydantic import BaseModel, Field, model_validator, EmailStr&#10;from typing import Optional&#10;&#10;class BuyerCreate(BaseModel):&#10;    name: str = Field(..., max_length=60)&#10;    phone: str = Field(..., max_length=20, pattern=r'^\+?\s?\d[\d\s]{5,17}$')&#10;    email: Optional[EmailStr] = Field(max_length=64)&#10;&#10;class BuyerDelete(BaseModel):&#10;    id: Optional[int] = None&#10;    name: Optional[str] = None&#10;    phone: Optional[str] = Field(max_length=20, pattern=r'^\+?\s?\d[\d\s]{5,17}$')&#10;&#10;    @model_validator(mode=&quot;after&quot;)&#10;    def check_valid_fields(self):&#10;        id, name, phone = (self.id, self.name, self.phone)&#10;        if id is None and (not name or not phone):&#10;            raise ValueError(&quot;You must send 'id' or the 'name' and 'phone' pair.&quot;)&#10;        return self&#10;&#10;class BuyerUpdate(BaseModel):&#10;    id: int&#10;    name: Optional[str] = Field(None, max_length=60)&#10;    phone: Optional[str] = Field(None, max_length=20, pattern=r'^\+?\s?\d[\d\s]{5,17}$')&#10;    email: Optional[EmailStr] = Field(None, max_length=64)&#10;&#10;    @model_validator(mode=&quot;after&quot;)&#10;    def check_valid_fields(self):&#10;        id, name, phone, email = (self.id, self.name, self.phone, self.email)&#10;        if id:&#10;            if name is None and phone is None and email is None:&#10;                raise ValueError(&quot;You must modify/update at least one value.&quot;)&#10;        else:&#10;            raise ValueError(&quot;Buyer id is required.&quot;)&#10;        return self" />
              <option name="updatedContent" value="from pydantic import BaseModel, Field, model_validator, EmailStr&#10;from typing import Optional&#10;&#10;class BuyerCreate(BaseModel):&#10;    name: str = Field(..., max_length=60)&#10;    phone: str = Field(..., max_length=20, pattern=r'^\+?\s?\d[\d\s]{5,17}$')&#10;    email: Optional[EmailStr] = Field(max_length=64)&#10;&#10;class BuyerDelete(BaseModel):&#10;    id: Optional[int] = None&#10;    name: Optional[str] = None&#10;    phone: Optional[str] = Field(None, max_length=20, pattern=r'^\+?\s?\d[\d\s]{5,17}$')&#10;&#10;    @model_validator(mode=&quot;after&quot;)&#10;    def check_valid_fields(self):&#10;        id, name, phone = (self.id, self.name, self.phone)&#10;        if id is None and (not name or not phone):&#10;            raise ValueError(&quot;You must send 'id' or the 'name' and 'phone' pair.&quot;)&#10;        return self&#10;&#10;class BuyerUpdate(BaseModel):&#10;    id: int&#10;    name: Optional[str] = Field(None, max_length=60)&#10;    phone: Optional[str] = Field(None, max_length=20, pattern=r'^\+?\s?\d[\d\s]{5,17}$')&#10;    email: Optional[EmailStr] = Field(None, max_length=64)&#10;&#10;    @model_validator(mode=&quot;after&quot;)&#10;    def check_valid_fields(self):&#10;        id, name, phone, email = (self.id, self.name, self.phone, self.email)&#10;        if id:&#10;            if name is None and phone is None and email is None:&#10;                raise ValueError(&quot;You must modify/update at least one value.&quot;)&#10;        else:&#10;            raise ValueError(&quot;Buyer id is required.&quot;)&#10;        return self" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/schemas/raffleset.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/schemas/raffleset.py" />
              <option name="originalContent" value="from pydantic import BaseModel, Field, model_validator&#10;from typing import Literal, Optional&#10;&#10;&#10;class RaffleSetCreate(BaseModel):&#10;    project_id: int&#10;    name: str = Field(..., max_length=60)&#10;    type: Literal[&quot;online&quot;, &quot;physical&quot;]&#10;    requested_count: int = Field(..., gt=0) # Not in database, used for raffles creation&#10;    unit_price: int = Field(..., gt=0)&#10;&#10;class RaffleSetOut(BaseModel):&#10;    id: int&#10;    name: str&#10;    init: int&#10;    final: int&#10;    unit_price: int&#10;&#10;    class Config:&#10;        from_attributes = True&#10;&#10;class RaffleSetUpdate(BaseModel):&#10;    id: int&#10;    name: Optional[str] = Field(..., max_length=60)&#10;    type: Optional[Literal[&quot;online&quot;, &quot;physical&quot;]] = Field(...)&#10;    unit_price: Optional[int] = Field(..., gt=0)&#10;&#10;    class Config:&#10;        from_attributes = True&#10;&#10;    @model_validator(mode=&quot;after&quot;)&#10;    def check_valid_fields(self):&#10;        id, name, type, unit_price = (self.id, self.name, self.type, self.unit_price)&#10;        if id:&#10;            if name is None and type is None and unit_price is None:&#10;                raise ValueError(&quot;You must modify/update at least one value.&quot;)&#10;        else:&#10;            raise ValueError(&quot;Set id is required.&quot;)&#10;        return self" />
              <option name="updatedContent" value="from pydantic import BaseModel, Field, model_validator, ConfigDict&#10;from typing import Literal, Optional&#10;&#10;&#10;class RaffleSetCreate(BaseModel):&#10;    project_id: int&#10;    name: str = Field(..., max_length=60)&#10;    type: Literal[&quot;online&quot;, &quot;physical&quot;]&#10;    requested_count: int = Field(..., gt=0) # Not in database, used for raffles creation&#10;    unit_price: int = Field(..., gt=0)&#10;&#10;class RaffleSetOut(BaseModel):&#10;    model_config = ConfigDict(from_attributes=True)&#10;    &#10;    id: int&#10;    name: str&#10;    init: int&#10;    final: int&#10;    unit_price: int&#10;&#10;class RaffleSetUpdate(BaseModel):&#10;    model_config = ConfigDict(from_attributes=True)&#10;    &#10;    id: int&#10;    name: Optional[str] = Field(None, max_length=60)&#10;    type: Optional[Literal[&quot;online&quot;, &quot;physical&quot;]] = Field(None)&#10;    unit_price: Optional[int] = Field(None, gt=0)&#10;&#10;    @model_validator(mode=&quot;after&quot;)&#10;    def check_valid_fields(self):&#10;        id, name, type, unit_price = (self.id, self.name, self.type, self.unit_price)&#10;        if id:&#10;            if name is None and type is None and unit_price is None:&#10;                raise ValueError(&quot;You must modify/update at least one value.&quot;)&#10;        else:&#10;            raise ValueError(&quot;Set id is required.&quot;)&#10;        return self" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/test.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/test.py" />
              <option name="originalContent" value="# test_api.py&#10;import pytest&#10;from fastapi.testclient import TestClient&#10;from sqlalchemy import create_engine, text&#10;from sqlalchemy.orm import sessionmaker&#10;from main import app&#10;from database.connection import get_db, Base&#10;from core.config_loader import settings&#10;from models.users import User&#10;&#10;# Test database setup&#10;TEST_DATABASE_URL = str(settings.SQLALCHEMY_DATABASE_URI).replace(&#10;    settings.MARIADB_DATABASE,&#10;    f&quot;test_{settings.MARIADB_DATABASE}&quot;&#10;)&#10;&#10;test_engine = create_engine(TEST_DATABASE_URL)&#10;TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=test_engine)&#10;&#10;def override_get_db():&#10;    try:&#10;        db = TestingSessionLocal()&#10;        yield db&#10;    finally:&#10;        db.close()&#10;&#10;app.dependency_overrides[get_db] = override_get_db&#10;client = TestClient(app)&#10;&#10;# Global variables for test data&#10;test_data = {&#10;    &quot;buyer_id&quot;: None,&#10;    &quot;project_id&quot;: None,&#10;    &quot;raffleset_id&quot;: None,&#10;    &quot;raffle_number&quot;: None&#10;}&#10;&#10;&#10;@pytest.fixture(scope=&quot;session&quot;, autouse=True)&#10;def setup_test_database():&#10;    &quot;&quot;&quot;Setup test database before all tests and cleanup after.&quot;&quot;&quot;&#10;    # Create test database&#10;    sys_engine = create_engine(f&quot;mysql+pymysql://{settings.MARIADB_USERNAME}:{settings.MARIADB_PASSWORD}@{settings.MARIADB_SERVER}&quot;)&#10;&#10;    with sys_engine.connect() as conn:&#10;        conn.execute(text(f&quot;DROP DATABASE IF EXISTS test_{settings.MARIADB_DATABASE}&quot;))&#10;        conn.execute(text(f&quot;CREATE DATABASE test_{settings.MARIADB_DATABASE}&quot;))&#10;        conn.commit()&#10;&#10;    # Create tables&#10;    Base.metadata.create_all(bind=test_engine)&#10;&#10;    # Create a test user for foreign key relationships&#10;    db = TestingSessionLocal()&#10;    test_user = User(&#10;        username=&quot;testuser&quot;,&#10;        email=&quot;test@example.com&quot;,&#10;        password_hash=&quot;hashedpassword123&quot;,  # Fixed field name&#10;        is_active=True&#10;    )&#10;    db.add(test_user)&#10;    db.commit()&#10;    db.close()&#10;&#10;    yield&#10;&#10;    # Cleanup after all tests&#10;    with sys_engine.connect() as conn:&#10;        conn.execute(text(f&quot;DROP DATABASE IF EXISTS test_{settings.MARIADB_DATABASE}&quot;))&#10;        conn.commit()&#10;&#10;&#10;def test_create_project():&#10;    &quot;&quot;&quot;Test project creation endpoint.&quot;&quot;&quot;&#10;    response = client.post(&quot;/project&quot;, json={&#10;        &quot;name&quot;: &quot;Test Project&quot;,&#10;        &quot;description&quot;: &quot;Test project description&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;name&quot;] == &quot;Test Project&quot;&#10;    assert data[&quot;description&quot;] == &quot;Test project description&quot;&#10;    assert &quot;id&quot; in data&#10;&#10;    test_data[&quot;project_id&quot;] = data[&quot;id&quot;]&#10;&#10;&#10;def test_get_project():&#10;    &quot;&quot;&quot;Test get single project endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.get(f&quot;/project?id={test_data['project_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;id&quot;] == test_data[&quot;project_id&quot;]&#10;    assert data[&quot;name&quot;] == &quot;Test Project&quot;&#10;&#10;&#10;def test_get_projects():&#10;    &quot;&quot;&quot;Test get all projects endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/projects&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 1&#10;&#10;&#10;def test_create_buyer():&#10;    &quot;&quot;&quot;Test buyer creation endpoint.&quot;&quot;&quot;&#10;    response = client.post(&quot;/buyer&quot;, json={&#10;        &quot;name&quot;: &quot;John Doe&quot;,&#10;        &quot;phone&quot;: &quot;+1234567890&quot;,&#10;        &quot;email&quot;: &quot;john@example.com&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;name&quot;] == &quot;John Doe&quot;&#10;    assert data[&quot;phone&quot;] == &quot;+1234567890&quot;&#10;    assert data[&quot;email&quot;] == &quot;john@example.com&quot;&#10;    assert &quot;id&quot; in data&#10;&#10;    test_data[&quot;buyer_id&quot;] = data[&quot;id&quot;]&#10;&#10;&#10;def test_get_buyer():&#10;    &quot;&quot;&quot;Test get single buyer endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;&#10;    response = client.get(f&quot;/buyer?id={test_data['buyer_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;id&quot;] == test_data[&quot;buyer_id&quot;]&#10;    assert data[&quot;name&quot;] == &quot;John Doe&quot;&#10;&#10;&#10;def test_get_buyers():&#10;    &quot;&quot;&quot;Test get all buyers endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/buyers&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 1&#10;&#10;&#10;def test_create_raffleset():&#10;    &quot;&quot;&quot;Test raffleset creation endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.post(&quot;/raffleset&quot;, json={&#10;        &quot;project_id&quot;: test_data[&quot;project_id&quot;],&#10;        &quot;name&quot;: &quot;Test Raffle Set&quot;,&#10;        &quot;type&quot;: &quot;online&quot;,&#10;        &quot;requested_count&quot;: 10,&#10;        &quot;unit_price&quot;: 1000&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert &quot;raffleset&quot; in data&#10;    assert &quot;range&quot; in data&#10;    assert data[&quot;raffleset&quot;][&quot;name&quot;] == &quot;Test Raffle Set&quot;&#10;&#10;    test_data[&quot;raffleset_id&quot;] = data[&quot;raffleset&quot;][&quot;id&quot;]&#10;    # Extract first raffle number from range&#10;    range_str = data[&quot;range&quot;]&#10;    test_data[&quot;raffle_number&quot;] = int(range_str.split(&quot;-&quot;)[0])&#10;&#10;&#10;def test_get_raffleset():&#10;    &quot;&quot;&quot;Test get single raffleset endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffleset_id&quot;] is not None&#10;&#10;    response = client.get(f&quot;/raffleset/{test_data['raffleset_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;id&quot;] == test_data[&quot;raffleset_id&quot;]&#10;    assert data[&quot;name&quot;] == &quot;Test Raffle Set&quot;&#10;&#10;&#10;def test_get_rafflesets():&#10;    &quot;&quot;&quot;Test get all rafflesets endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/rafflesets&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 1&#10;&#10;&#10;def test_get_raffle():&#10;    &quot;&quot;&quot;Test get single raffle endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffle_number&quot;] is not None&#10;&#10;    response = client.get(f&quot;/raffle?number={test_data['raffle_number']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;number&quot;] == test_data[&quot;raffle_number&quot;]&#10;    assert data[&quot;state&quot;] == &quot;available&quot;&#10;&#10;&#10;def test_get_raffles():&#10;    &quot;&quot;&quot;Test get all raffles endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/raffles&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 10  # We created 10 raffles&#10;&#10;&#10;def test_pay_raffle():&#10;    &quot;&quot;&quot;Test raffle payment endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffle_number&quot;] is not None&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;&#10;    response = client.post(&quot;/raffle/pay&quot;, json={&#10;        &quot;number&quot;: test_data[&quot;raffle_number&quot;],&#10;        &quot;buyer_id&quot;: test_data[&quot;buyer_id&quot;],&#10;        &quot;payment_method&quot;: &quot;card&quot;,&#10;        &quot;state&quot;: &quot;sold&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;number&quot;] == test_data[&quot;raffle_number&quot;]&#10;    assert data[&quot;buyer_id&quot;] == test_data[&quot;buyer_id&quot;]&#10;    assert data[&quot;state&quot;] == &quot;sold&quot;&#10;    assert data[&quot;payment_method&quot;] == &quot;card&quot;&#10;&#10;&#10;def test_update_buyer():&#10;    &quot;&quot;&quot;Test buyer update endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;&#10;    response = client.patch(&quot;/buyer&quot;, json={&#10;        &quot;id&quot;: test_data[&quot;buyer_id&quot;],&#10;        &quot;name&quot;: &quot;John Smith&quot;,&#10;        &quot;email&quot;: &quot;johnsmith@example.com&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;name&quot;] == &quot;John Smith&quot;&#10;    assert data[&quot;email&quot;] == &quot;johnsmith@example.com&quot;&#10;&#10;&#10;def test_update_project():&#10;    &quot;&quot;&quot;Test project update endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.patch(&quot;/project&quot;, json={&#10;        &quot;id&quot;: test_data[&quot;project_id&quot;],&#10;        &quot;description&quot;: &quot;Updated project description&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;description&quot;] == &quot;Updated project description&quot;&#10;&#10;&#10;def test_update_raffle():&#10;    &quot;&quot;&quot;Test raffle update endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffle_number&quot;] is not None&#10;&#10;    response = client.patch(&quot;/raffle&quot;, json={&#10;        &quot;number&quot;: test_data[&quot;raffle_number&quot;],&#10;        &quot;state&quot;: &quot;reserved&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;state&quot;] == &quot;reserved&quot;&#10;&#10;&#10;def test_delete_raffleset():&#10;    &quot;&quot;&quot;Test raffleset deletion endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffleset_id&quot;] is not None&#10;&#10;    response = client.delete(f&quot;/raffleset/{test_data['raffleset_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert &quot;message&quot; in data&#10;    assert &quot;deleted successfully&quot; in data[&quot;message&quot;]&#10;&#10;&#10;def test_delete_buyer():&#10;    &quot;&quot;&quot;Test buyer deletion endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;    print(test_data)&#10;    # Use proper content parameter for DELETE request with JSON body&#10;    response = client.request(&#10;        &quot;DELETE&quot;,&#10;        &quot;/buyer&quot;,&#10;        content=f'{{&quot;id&quot;: {test_data[&quot;buyer_id&quot;]}}}',&#10;        headers={&quot;Content-Type&quot;: &quot;application/json&quot;}&#10;    )&#10;    print(response)&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert &quot;message&quot; in data&#10;    assert &quot;deleted successfully&quot; in data[&quot;message&quot;]&#10;&#10;&#10;def test_delete_project():&#10;    &quot;&quot;&quot;Test project deletion endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.delete(f&quot;/project?id={test_data['project_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert &quot;message&quot; in data&#10;    assert &quot;deleted successfully&quot; in data[&quot;message&quot;]&#10;&#10;&#10;# Error handling tests&#10;def test_get_nonexistent_project():&#10;    &quot;&quot;&quot;Test getting a non-existent project returns 404.&quot;&quot;&quot;&#10;    response = client.get(&quot;/project?id=99999&quot;)&#10;    assert response.status_code == 404&#10;&#10;&#10;def test_get_nonexistent_buyer():&#10;    &quot;&quot;&quot;Test getting a non-existent buyer returns 404.&quot;&quot;&quot;&#10;    response = client.get(&quot;/buyer?id=99999&quot;)&#10;    assert response.status_code == 404&#10;&#10;&#10;def test_get_nonexistent_raffle():&#10;    &quot;&quot;&quot;Test getting a non-existent raffle returns 404.&quot;&quot;&quot;&#10;    response = client.get(&quot;/raffle?number=99999&quot;)&#10;    assert response.status_code == 404&#10;&#10;&#10;def test_create_duplicate_project():&#10;    &quot;&quot;&quot;Test creating a project with duplicate name returns 400.&quot;&quot;&quot;&#10;    # Create first project&#10;    client.post(&quot;/project&quot;, json={&#10;        &quot;name&quot;: &quot;Duplicate Test&quot;,&#10;        &quot;description&quot;: &quot;First project&quot;&#10;    })&#10;&#10;    # Try to create duplicate&#10;    response = client.post(&quot;/project&quot;, json={&#10;        &quot;name&quot;: &quot;Duplicate Test&quot;,&#10;        &quot;description&quot;: &quot;Second project&quot;&#10;    })&#10;&#10;    assert response.status_code == 400&#10;&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    pytest.main([__file__, &quot;-v&quot;])&#10;" />
              <option name="updatedContent" value="# test_api.py&#10;import pytest&#10;from fastapi.testclient import TestClient&#10;from sqlalchemy import create_engine, text&#10;from sqlalchemy.orm import sessionmaker&#10;from main import app&#10;from database.connection import get_db, Base&#10;from core.config_loader import settings&#10;from models.users import User&#10;&#10;# Test database setup&#10;TEST_DATABASE_URL = str(settings.SQLALCHEMY_DATABASE_URI).replace(&#10;    settings.MARIADB_DATABASE,&#10;    f&quot;test_{settings.MARIADB_DATABASE}&quot;&#10;)&#10;&#10;test_engine = create_engine(TEST_DATABASE_URL)&#10;TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=test_engine)&#10;&#10;def override_get_db():&#10;    try:&#10;        db = TestingSessionLocal()&#10;        yield db&#10;    finally:&#10;        db.close()&#10;&#10;app.dependency_overrides[get_db] = override_get_db&#10;client = TestClient(app)&#10;&#10;# Global variables for test data&#10;test_data = {&#10;    &quot;buyer_id&quot;: None,&#10;    &quot;project_id&quot;: None,&#10;    &quot;raffleset_id&quot;: None,&#10;    &quot;raffle_number&quot;: None&#10;}&#10;&#10;&#10;@pytest.fixture(scope=&quot;session&quot;, autouse=True)&#10;def setup_test_database():&#10;    &quot;&quot;&quot;Setup test database before all tests and cleanup after.&quot;&quot;&quot;&#10;    # Create test database&#10;    sys_engine = create_engine(f&quot;mysql+pymysql://{settings.MARIADB_USERNAME}:{settings.MARIADB_PASSWORD}@{settings.MARIADB_SERVER}&quot;)&#10;&#10;    with sys_engine.connect() as conn:&#10;        conn.execute(text(f&quot;DROP DATABASE IF EXISTS test_{settings.MARIADB_DATABASE}&quot;))&#10;        conn.execute(text(f&quot;CREATE DATABASE test_{settings.MARIADB_DATABASE}&quot;))&#10;        conn.commit()&#10;&#10;    # Create tables&#10;    Base.metadata.create_all(bind=test_engine)&#10;&#10;    # Create a test user for foreign key relationships&#10;    db = TestingSessionLocal()&#10;    test_user = User(&#10;        username=&quot;testuser&quot;,&#10;        email=&quot;test@example.com&quot;,&#10;        password_hash=&quot;hashedpassword123&quot;,  # Fixed field name&#10;        is_active=True&#10;    )&#10;    db.add(test_user)&#10;    db.commit()&#10;    db.close()&#10;&#10;    yield&#10;&#10;    # Cleanup after all tests&#10;    with sys_engine.connect() as conn:&#10;        conn.execute(text(f&quot;DROP DATABASE IF EXISTS test_{settings.MARIADB_DATABASE}&quot;))&#10;        conn.commit()&#10;&#10;&#10;def test_create_project():&#10;    &quot;&quot;&quot;Test project creation endpoint.&quot;&quot;&quot;&#10;    response = client.post(&quot;/project&quot;, json={&#10;        &quot;name&quot;: &quot;Test Project&quot;,&#10;        &quot;description&quot;: &quot;Test project description&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;name&quot;] == &quot;Test Project&quot;&#10;    assert data[&quot;description&quot;] == &quot;Test project description&quot;&#10;    assert &quot;id&quot; in data&#10;&#10;    test_data[&quot;project_id&quot;] = data[&quot;id&quot;]&#10;&#10;&#10;def test_get_project():&#10;    &quot;&quot;&quot;Test get single project endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.get(f&quot;/project?id={test_data['project_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;id&quot;] == test_data[&quot;project_id&quot;]&#10;    assert data[&quot;name&quot;] == &quot;Test Project&quot;&#10;&#10;&#10;def test_get_projects():&#10;    &quot;&quot;&quot;Test get all projects endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/projects&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 1&#10;&#10;&#10;def test_create_buyer():&#10;    &quot;&quot;&quot;Test buyer creation endpoint.&quot;&quot;&quot;&#10;    response = client.post(&quot;/buyer&quot;, json={&#10;        &quot;name&quot;: &quot;John Doe&quot;,&#10;        &quot;phone&quot;: &quot;+1234567890&quot;,&#10;        &quot;email&quot;: &quot;john@example.com&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;name&quot;] == &quot;John Doe&quot;&#10;    assert data[&quot;phone&quot;] == &quot;+1234567890&quot;&#10;    assert data[&quot;email&quot;] == &quot;john@example.com&quot;&#10;    assert &quot;id&quot; in data&#10;&#10;    test_data[&quot;buyer_id&quot;] = data[&quot;id&quot;]&#10;&#10;&#10;def test_get_buyer():&#10;    &quot;&quot;&quot;Test get single buyer endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;&#10;    response = client.get(f&quot;/buyer?id={test_data['buyer_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;id&quot;] == test_data[&quot;buyer_id&quot;]&#10;    assert data[&quot;name&quot;] == &quot;John Doe&quot;&#10;&#10;&#10;def test_get_buyers():&#10;    &quot;&quot;&quot;Test get all buyers endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/buyers&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 1&#10;&#10;&#10;def test_create_raffleset():&#10;    &quot;&quot;&quot;Test raffleset creation endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.post(&quot;/raffleset&quot;, json={&#10;        &quot;project_id&quot;: test_data[&quot;project_id&quot;],&#10;        &quot;name&quot;: &quot;Test Raffle Set&quot;,&#10;        &quot;type&quot;: &quot;online&quot;,&#10;        &quot;requested_count&quot;: 10,&#10;        &quot;unit_price&quot;: 1000&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert &quot;raffleset&quot; in data&#10;    assert &quot;range&quot; in data&#10;    assert data[&quot;raffleset&quot;][&quot;name&quot;] == &quot;Test Raffle Set&quot;&#10;&#10;    test_data[&quot;raffleset_id&quot;] = data[&quot;raffleset&quot;][&quot;id&quot;]&#10;    # Extract first raffle number from range&#10;    range_str = data[&quot;range&quot;]&#10;    test_data[&quot;raffle_number&quot;] = int(range_str.split(&quot;-&quot;)[0])&#10;&#10;&#10;def test_get_raffleset():&#10;    &quot;&quot;&quot;Test get single raffleset endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffleset_id&quot;] is not None&#10;&#10;    response = client.get(f&quot;/raffleset/{test_data['raffleset_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;id&quot;] == test_data[&quot;raffleset_id&quot;]&#10;    assert data[&quot;name&quot;] == &quot;Test Raffle Set&quot;&#10;&#10;&#10;def test_get_rafflesets():&#10;    &quot;&quot;&quot;Test get all rafflesets endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/rafflesets&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 1&#10;&#10;&#10;def test_get_raffle():&#10;    &quot;&quot;&quot;Test get single raffle endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffle_number&quot;] is not None&#10;&#10;    response = client.get(f&quot;/raffle?number={test_data['raffle_number']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert data[&quot;number&quot;] == test_data[&quot;raffle_number&quot;]&#10;    assert data[&quot;state&quot;] == &quot;available&quot;&#10;&#10;&#10;def test_get_raffles():&#10;    &quot;&quot;&quot;Test get all raffles endpoint.&quot;&quot;&quot;&#10;    response = client.get(&quot;/raffles&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert isinstance(data, list)&#10;    assert len(data) &gt;= 10  # We created 10 raffles&#10;&#10;&#10;def test_pay_raffle():&#10;    &quot;&quot;&quot;Test raffle payment endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffle_number&quot;] is not None&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;&#10;    response = client.post(&quot;/raffle/pay&quot;, json={&#10;        &quot;number&quot;: test_data[&quot;raffle_number&quot;],&#10;        &quot;buyer_id&quot;: test_data[&quot;buyer_id&quot;],&#10;        &quot;payment_method&quot;: &quot;card&quot;,&#10;        &quot;state&quot;: &quot;sold&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;number&quot;] == test_data[&quot;raffle_number&quot;]&#10;    assert data[&quot;buyer_id&quot;] == test_data[&quot;buyer_id&quot;]&#10;    assert data[&quot;state&quot;] == &quot;sold&quot;&#10;    assert data[&quot;payment_method&quot;] == &quot;card&quot;&#10;&#10;&#10;def test_update_buyer():&#10;    &quot;&quot;&quot;Test buyer update endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;&#10;    response = client.patch(&quot;/buyer&quot;, json={&#10;        &quot;id&quot;: test_data[&quot;buyer_id&quot;],&#10;        &quot;name&quot;: &quot;John Smith&quot;,&#10;        &quot;email&quot;: &quot;johnsmith@example.com&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;name&quot;] == &quot;John Smith&quot;&#10;    assert data[&quot;email&quot;] == &quot;johnsmith@example.com&quot;&#10;&#10;&#10;def test_update_project():&#10;    &quot;&quot;&quot;Test project update endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.patch(&quot;/project&quot;, json={&#10;        &quot;id&quot;: test_data[&quot;project_id&quot;],&#10;        &quot;description&quot;: &quot;Updated project description&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;description&quot;] == &quot;Updated project description&quot;&#10;&#10;&#10;def test_update_raffle():&#10;    &quot;&quot;&quot;Test raffle update endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffle_number&quot;] is not None&#10;&#10;    response = client.patch(&quot;/raffle&quot;, json={&#10;        &quot;number&quot;: test_data[&quot;raffle_number&quot;],&#10;        &quot;state&quot;: &quot;reserved&quot;&#10;    })&#10;&#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert data[&quot;state&quot;] == &quot;reserved&quot;&#10;&#10;&#10;def test_delete_raffleset():&#10;    &quot;&quot;&quot;Test raffleset deletion endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;raffleset_id&quot;] is not None&#10;&#10;    response = client.delete(f&quot;/raffleset/{test_data['raffleset_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert &quot;message&quot; in data&#10;    assert &quot;deleted successfully&quot; in data[&quot;message&quot;]&#10;&#10;&#10;def test_delete_buyer():&#10;    &quot;&quot;&quot;Test buyer deletion endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;buyer_id&quot;] is not None&#10;    &#10;    # Use proper JSON parameter for DELETE request - FastAPI can handle this&#10;    response = client.request(&#10;        &quot;DELETE&quot;, &#10;        &quot;/buyer&quot;, &#10;        json={&quot;id&quot;: test_data[&quot;buyer_id&quot;]}&#10;    )&#10;    &#10;    assert response.status_code == 200&#10;    data = response.json()&#10;    assert &quot;message&quot; in data&#10;    assert &quot;deleted successfully&quot; in data[&quot;message&quot;]&#10;&#10;&#10;def test_delete_project():&#10;    &quot;&quot;&quot;Test project deletion endpoint.&quot;&quot;&quot;&#10;    assert test_data[&quot;project_id&quot;] is not None&#10;&#10;    response = client.delete(f&quot;/project?id={test_data['project_id']}&quot;)&#10;    assert response.status_code == 200&#10;&#10;    data = response.json()&#10;    assert &quot;message&quot; in data&#10;    assert &quot;deleted successfully&quot; in data[&quot;message&quot;]&#10;&#10;&#10;# Error handling tests&#10;def test_get_nonexistent_project():&#10;    &quot;&quot;&quot;Test getting a non-existent project returns 404.&quot;&quot;&quot;&#10;    response = client.get(&quot;/project?id=99999&quot;)&#10;    assert response.status_code == 404&#10;&#10;&#10;def test_get_nonexistent_buyer():&#10;    &quot;&quot;&quot;Test getting a non-existent buyer returns 404.&quot;&quot;&quot;&#10;    response = client.get(&quot;/buyer?id=99999&quot;)&#10;    assert response.status_code == 404&#10;&#10;&#10;def test_get_nonexistent_raffle():&#10;    &quot;&quot;&quot;Test getting a non-existent raffle returns 404.&quot;&quot;&quot;&#10;    response = client.get(&quot;/raffle?number=99999&quot;)&#10;    assert response.status_code == 404&#10;&#10;&#10;def test_create_duplicate_project():&#10;    &quot;&quot;&quot;Test creating a project with duplicate name returns 400.&quot;&quot;&quot;&#10;    # Create first project&#10;    client.post(&quot;/project&quot;, json={&#10;        &quot;name&quot;: &quot;Duplicate Test&quot;,&#10;        &quot;description&quot;: &quot;First project&quot;&#10;    })&#10;&#10;    # Try to create duplicate&#10;    response = client.post(&quot;/project&quot;, json={&#10;        &quot;name&quot;: &quot;Duplicate Test&quot;,&#10;        &quot;description&quot;: &quot;Second project&quot;&#10;    })&#10;&#10;    assert response.status_code == 400&#10;&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    pytest.main([__file__, &quot;-v&quot;])" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/test_minimal.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/test_minimal.py" />
              <option name="updatedContent" value="#!/usr/bin/env python3&#10;&quot;&quot;&quot;&#10;Minimal test to verify the application works&#10;&quot;&quot;&quot;&#10;import os&#10;import sys&#10;sys.path.insert(0, '/home/gonzadev/Proyectos/python/raffles-manager')&#10;&#10;def test_minimal():&#10;    &quot;&quot;&quot;Minimal test to check if basic functionality works&quot;&quot;&quot;&#10;    try:&#10;        print(&quot; Starting minimal test...&quot;)&#10;        &#10;        # Test 1: Basic imports&#10;        print(&quot;1. Testing basic imports...&quot;)&#10;        import fastapi&#10;        import sqlalchemy&#10;        print(&quot;✅ Basic dependencies imported&quot;)&#10;        &#10;        # Test 2: Environment variables&#10;        print(&quot;2. Testing environment...&quot;)&#10;        if os.path.exists('.env'):&#10;            print(&quot;✅ .env file exists&quot;)&#10;        else:&#10;            print(&quot;❌ .env file missing&quot;)&#10;            &#10;        # Test 3: Try config import&#10;        print(&quot;3. Testing config import...&quot;)&#10;        try:&#10;            from core.config_loader import settings&#10;            print(f&quot;✅ Config loaded - DB: {settings.MARIADB_DATABASE}&quot;)&#10;        except Exception as e:&#10;            print(f&quot;❌ Config failed: {e}&quot;)&#10;            return False&#10;            &#10;        # Test 4: Try database connection&#10;        print(&quot;4. Testing database connection...&quot;)&#10;        try:&#10;            from database.connection import engine&#10;            print(&quot;✅ Database engine created&quot;)&#10;        except Exception as e:&#10;            print(f&quot;❌ Database failed: {e}&quot;)&#10;            return False&#10;            &#10;        print(&quot;✅ All basic tests passed!&quot;)&#10;        return True&#10;        &#10;    except Exception as e:&#10;        print(f&quot;❌ Test failed: {e}&quot;)&#10;        return False&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    success = test_minimal()&#10;    if success:&#10;        print(&quot;\n Ready to run full tests!&quot;)&#10;    else:&#10;        print(&quot;\n Fix the issues above before running tests&quot;)&#10;        sys.exit(1)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/test_simple.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/test_simple.py" />
              <option name="updatedContent" value="#!/usr/bin/env python3&#10;&quot;&quot;&quot;&#10;Simplified test file that bypasses import hanging issues&#10;&quot;&quot;&quot;&#10;import sys&#10;import os&#10;&#10;# Add the project root to Python path&#10;sys.path.insert(0, '/home/gonzadev/Proyectos/python/raffles-manager')&#10;&#10;def test_basic_imports():&#10;    &quot;&quot;&quot;Test basic imports work&quot;&quot;&quot;&#10;    try:&#10;        print(&quot;Testing config import...&quot;)&#10;        from core.config_loader import settings&#10;        print(&quot;✅ Config loaded successfully&quot;)&#10;        &#10;        print(&quot;Testing database import...&quot;)&#10;        from database.connection import Base&#10;        print(&quot;✅ Database connection imported&quot;)&#10;        &#10;        print(&quot;Testing models import...&quot;)&#10;        from models.buyer import Buyer&#10;        print(&quot;✅ Models imported&quot;)&#10;        &#10;        print(&quot;Testing FastAPI app...&quot;)&#10;        from fastapi import FastAPI&#10;        app = FastAPI()&#10;        print(&quot;✅ FastAPI app created&quot;)&#10;        &#10;        return True&#10;    except Exception as e:&#10;        print(f&quot;❌ Import failed: {e}&quot;)&#10;        return False&#10;&#10;def test_database_url():&#10;    &quot;&quot;&quot;Test database URL generation&quot;&quot;&quot;&#10;    try:&#10;        from core.config_loader import settings&#10;        db_url = str(settings.SQLALCHEMY_DATABASE_URI)&#10;        print(f&quot;Database URL: {db_url}&quot;)&#10;        return True&#10;    except Exception as e:&#10;        print(f&quot;❌ Database URL test failed: {e}&quot;)&#10;        return False&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    print(&quot; Running simplified tests...&quot;)&#10;    &#10;    if test_basic_imports():&#10;        print(&quot;\n Testing database URL...&quot;)&#10;        test_database_url()&#10;        print(&quot;\n✅ Basic tests completed successfully!&quot;)&#10;    else:&#10;        print(&quot;\n❌ Basic tests failed!&quot;)&#10;        sys.exit(1)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="/tmp/create-database-fixed.sql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="/tmp/create-database-fixed.sql" />
              <option name="updatedContent" value="CREATE SCHEMA IF NOT EXISTS raffles_schema;&#10;&#10;SET search_path TO raffles_schema, public;&#10;&#10;CREATE TABLE proyects (&#10;    id SERIAL PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    description TEXT,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    isActive BOOL DEFAULT true&#10;);&#10;&#10;CREATE TABLE rafflesSet (&#10;    id SERIAL PRIMARY KEY,&#10;    proyect_id INTEGER REFERENCES proyects(id),&#10;    name VARCHAR(100) NOT NULL,&#10;    type VARCHAR(8) NOT NULL CHECK (type IN ('online', 'physical')),&#10;    init INTEGER NOT NULL,&#10;    final INTEGER NOT NULL,&#10;    unit_price INTEGER NOT NULL ,&#10;    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,&#10;    CONSTRAINT valid_numbers CHECK (init &lt; final),&#10;    CONSTRAINT unique_set UNIQUE (proyect_id, name)&#10;);&#10;&#10;CREATE TABLE buyers (&#10;    id SERIAL PRIMARY KEY,&#10;    name VARCHAR(100) NOT NULL,&#10;    email VARCHAR(100) UNIQUE NOT NULL,&#10;    phone VARCHAR(20),&#10;    register_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#10;);&#10;&#10;CREATE TABLE raffles ( -- Units&#10;    set_id INTEGER NOT NULL REFERENCES rafflesSet(id),&#10;    number INTEGER NOT NULL,&#10;    sell_date TIMESTAMP,&#10;    buyer_id INTEGER,&#10;    payment_method VARCHAR(50) CHECK (payment_method in ('CASH', 'CARD', 'TRANSFER', 'OTHER')),&#10;    state VARCHAR(20) DEFAULT 'available' CHECK (state IN ('available', 'sold', 'reserved')),&#10;    FOREIGN KEY (buyer_id) REFERENCES buyers(id),&#10;    PRIMARY KEY (set_id, number)&#10;);&#10;&#10;CREATE OR REPLACE FUNCTION generate_raffles()&#10;RETURNS TRIGGER AS $$&#10;DECLARE&#10;    next_number INTEGER;&#10;    count_numbers INTEGER;&#10;BEGIN&#10;&#10;    SELECT COALESCE(MAX(number), 0) + 1 INTO next_number FROM raffles;&#10;&#10;    -- Calculate how many numbers we need to generate&#10;    count_numbers := NEW.final - NEW.init + 1;&#10;&#10;    -- Update the rafflesSet with the actual init and final values&#10;    UPDATE rafflesSet&#10;    SET init = next_number,&#10;        final = next_number + count_numbers - 1&#10;    WHERE id = NEW.id;&#10;&#10;    -- Insert the raffle numbers&#10;    INSERT INTO raffles (set_id, number)&#10;    SELECT NEW.id, generate_series(next_number, next_number + count_numbers - 1);&#10;&#10;    RETURN NEW;&#10;END;&#10;$$ LANGUAGE plpgsql;&#10;&#10;CREATE TRIGGER trig_generate_raffles&#10;AFTER INSERT ON rafflesSet&#10;FOR EACH ROW&#10;EXECUTE FUNCTION generate_raffles();" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>